<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Dashboard - ABElektronik</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    :root {
      --color-bg-light: #f9f9f9;
      --color-bg-dark: #121212;
      --color-text-light: #222;
      --color-text-dark: #eee;
      --color-primary-light: #007bff;
      --color-primary-dark: #3399ff;
      --color-shadow-light: rgba(0,0,0,0.1);
      --color-shadow-dark: rgba(0,0,0,0.8);
    }

    /* Existing styles... */

    .copyright-container {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      padding: 10px 0;
    }
    .copyright-link {
      text-decoration: none;
      color: inherit;
    }

    .copyright {
      font-size: 0.8rem;
      margin: 0;
      color: #2676d1;
      transition: color 0.3s ease;
    }

  
        @keyframes fadeIn {
            from {
                opacity: 0; /* Start fully transparent */
                transform: translateY(-20px); /* Start slightly above */
            }
            to {
                opacity: 1; /* End fully opaque */
                transform: translateY(0); /* End in original position */
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1); /* Original size */
            }
            50% {
                transform: scale(1.05); /* Slightly larger */
            }
        }

        @keyframes backgroundWave {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 0%; }
        }

        .center-section {
            text-align: center; /* Center the text */
            margin: 20px; /* Add some margin */
            position: relative; /* Position for child elements */
        }

        .company-name h1 {
        font-family: 'Roboto', sans-serif; /* Font family for company name */
        font-size: 48px; /* Font size for company name */
        background: linear-gradient(45deg, #00f0ff, #0072ff); /* Electric blue gradient */
        background-clip: text; /* Standard property for clipping background to text */
        -webkit-background-clip: text; /* Clip background to text for WebKit browsers */
        -webkit-text-fill-color: transparent; /* Make text transparent to show gradient */
        text-shadow: 0 0 5px rgba(0, 240, 255, 0.7), 0 0 10px rgba(0, 114, 255, 0.5); /* Glowing effect */
        text-decoration: none; /* Remove underline from link */
        animation: fadeIn 1s ease-in; /* Apply fade-in animation */
        transition: color 0.3s, transform 0.3s; /* Smooth transition for hover effect */
        position: relative; /* Position for pseudo-element */
    }


        .company-name h1:hover {
            animation: pulse 0.5s infinite; /* Pulse animation on hover */
            text-shadow: 0 0 20px rgba(0, 255, 255, 1), 0 0 30px rgba(0, 114, 255, 1); /* Enhanced glow on hover */
        }

        .company-address p {
            font-family: 'Arial', sans-serif; /* Font family for company address */
            font-size: 24px; /* Font size for company address */
            color: #2c3e50; /* Text color for company address */
            margin-top: 10px; /* Space above the address */
            animation: fadeIn 1s ease-in 0.5s; /* Apply fade-in animation with delay */
            transition: color 0.3s, transform 0.3s; /* Smooth transition for hover effect */
        }

        .company-address p:hover {
            color: #34495e; /* Darker gray on hover */
            transform: scale(1.02); /* Slightly larger on hover */
        }


    body.dark .copyright {
      color: #bbb;
    }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background-color: var(--color-bg-light);
      color: var(--color-text-light);
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-height: 600px;
      max-width: 350px;
      margin-left: auto;
      margin-right: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    body.dark {
      background-color: var(--color-bg-dark);
      color: var(--color-text-dark);
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: var(--color-bg-light);
      padding: 12px 16px;
      box-shadow: 0 2px 5px var(--color-shadow-light);
      flex-shrink: 0;
      transition: background-color 0.3s ease;
    }

    body.dark header {
      background-color: #1c1c1c;
      box-shadow: 0 2px 8px var(--color-shadow-dark);
    }

    .profile-photo {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-image: url('https://drive.google.com/file/d/1l-4kkYHNf3oz1u0--F0Ysu-Sdi1o39fO/view?usp=sharing');
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
      border: 1.5px solid #ccc;
      transition: border-color 0.3s ease;
    }

    body.dark .profile-photo {
      border-color: #555;
    }

    .center-section {
      flex-grow: 1;
      text-align: center;
      user-select: none;
    }

    .center-section h1 {
      font-weight: 600;
      margin: 0;
      font-size: 1.25rem;
      line-height: 1.2;
      color: var(--color-text-light);
      transition: color 0.3s ease;
    }

    body.dark .center-section h1 {
      color: var(--color-text-dark);
    }

    .center-section p {
      margin: 2px 0 0 0;
      font-size: 0.8rem;
      color: #666;
      font-weight: 400;
      line-height: 1.2;
      transition: color 0.3s ease;
    }

    body.dark .center-section p {
      color: #bbb;
    }

    .btn-shutdown {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background-color 0.2s ease-in-out;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e03e2f;
    }

    .btn-shutdown:hover,
    .btn-shutdown:focus {
      background-color: #f8d7d4;
      outline: none;
    }

    /* Shutdown icon (power symbol) */
    .btn-shutdown svg {
      width: 24px;
      height: 24px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
    }

    main {
      flex-grow: 1;
      background: var(--color-bg-light);
      margin: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 2px 6px var(--color-shadow-light);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px;
      overflow: visible; /* Changed from hidden to visible */
      transition: background-color 0.3s ease, box-shadow 0.3s ease, color 0.3s ease;
      position: relative;
      min-height: 400px;
      padding-bottom: 80px; /* Reduced padding to bring buttons closer to revenue container */
      margin-bottom: 60px;
    }

    body.dark main {
      background: #222;
      box-shadow: 0 2px 8px var(--color-shadow-dark);
      color: var(--color-text-dark);
    }

    #chart-scroll-container {
      width: 100%;
      max-width: 350px;
      overflow-x: auto;
      margin-bottom: 12px;
    }

    .charts-wrapper {
      display: flex;
      gap: 20px;
      min-width: 700px; /* supaya bisa scroll horizontal */
    }

    .chart-box {
      flex: 0 0 320px;
      background: #fff;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4);
    }

    canvas {
      width: 80% !important;
      height: 220px !important;
    }

    
    .button-group {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 320px;
      gap: 12px;
      margin-bottom: 12px;
      position: absolute; /* Changed to absolute positioning */
      bottom: 100px; /* Position buttons 60px from bottom, closer to revenue container */
      left: 50%;
      transform: translateX(-50%);
      z-index: 5;
    }

    /* Updated revenue container positioning */
    .revenue-container {
      width: 100%;
      max-width: 320px;
      background: #ffffff;
      color: #000000;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4);
      user-select: none;
      font-weight: 600;
      font-size: 1.25rem;
      text-align: center;
      border-left: 4px solid #27ae60;
      position: absolute;
      bottom: 5px; /* Keep at 5px from bottom */
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
    }

    .btn-action {
      flex: 1;
      background-color: var(--color-primary-light);
      border: none;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      border-radius: 8px;
      padding: 10px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
    }

    .btn-action:hover,
    .btn-action:focus {
      background-color: var(--color-primary-dark);
      outline: none;
      box-shadow: 0 0 8px rgba(51, 153, 255, 0.6);
    }

    .btn-action svg {
      width: 24px;
      height: 24px;
      margin-bottom: 6px;
      stroke: white;
      stroke-width: 2;
      fill: none;
    }

    .btn-action.data-barang {
      background-color: #007bff;
      color: white;
    }

    .btn-action.history-barang {
      background-color: #27ae60;
      color: white;
    }

    .btn-action.laporan {
      background-color: #ff9800;
      color: white;
    }

/* Button Animation Styles */
.btn-animated {
  transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.btn-animated:active {
  transform: scale(0.95);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(29, 30, 34, 0.85);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999; /* Tingkatkan z-index agar lebih tinggi dari navigation */
  transition: opacity 0.3s ease;
  opacity: 0;
}

#overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(5px);
  z-index: 9999; /* Tingkatkan z-index agar lebih tinggi dari navigation */
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

#overlay.active {
  opacity: 1;
  visibility: visible;
}

.overlay.active {
  display: flex;
  opacity: 1;
}

/* Modal Container */
.modal {
  background: linear-gradient(145deg, #ffffff, #d3e0ea);
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(15, 15, 40, 0.2);
  width: 350px;
  max-width: 90%;
  max-height: 85vh; /* Batasi tinggi maksimal */
  padding: 1rem 1.5rem 1.5rem 1.5rem; /* Kurangi padding */
  position: relative;
  text-align: center;
  color: #222;
  transform: scale(0.9);
  transition: transform 0.3s ease;
  overflow-y: auto; /* Jika tetap perlu scroll */
  z-index: 10000; /* Pastikan modal memiliki z-index tertinggi */
}

.modal.active {
  transform: scale(1);
}

/* Modal Title */
.modal h2 {
  font-weight: 600;
  font-size: 1.8rem;
  margin-bottom: 1rem;
  background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
  background-clip: text;
  -webkit-background-clip: text;
  color: transparent;
}

/* Scanner Viewport */
.viewport {
  width: 100%;
  height: 120px; /* Dikurangi dari 160px menjadi 120px */
  background: #000;
  border-radius: 14px;
  object-fit: cover;
  box-shadow: 0 8px 25px rgba(37, 117, 252, 0.3);
  margin-bottom: 0.8rem; /* Kurangi margin */
  border: 3px solid #6a11cb;
  overflow: hidden;
  position: relative;
}

.viewport.scanner-active::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  height: 2px;
  background: rgba(106, 17, 203, 0.7);
  box-shadow: 0 0 8px 2px rgba(106, 17, 203, 0.7);
  animation: scanning 2s linear infinite;
  z-index: 10;
}

@keyframes scanning {
  0% { transform: translateY(-40px); }
  50% { transform: translateY(40px); }
  100% { transform: translateY(-40px); }
}

/* Subtitle with icon */
.subtitle {
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: 700;
  font-size: 1.1rem; /* Dikurangi dari 1.25rem */
  margin: 0.5rem 0 0.8rem 0; /* Dikurangi margin */
  color: #6a11cb;
  text-align: center;
  gap: 0.5rem;
}

.subtitle svg {
  width: 24px;
  height: 24px;
  fill: #6a11cb;
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.15);
    opacity: 0.75;
  }
}

/* Input Fields Container */
.input-group {
  display: flex;
  flex-direction: column;
  margin-bottom: 0.8rem; /* Dikurangi dari 1rem */
  text-align: left;
  position: relative;
}

label {
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 0.3rem;
  color: #404040;
}

/* Input with icon wrapper */
.input-icon-wrapper {
  display: flex;
  align-items: center;
  border: 2px solid #2575fc;
  border-radius: 12px;
  background: white;
  padding-left: 0.75rem;
  transition: border-color 0.3s ease;
  position: relative;
}

.input-icon-wrapper:focus-within {
  border-color: #6a11cb;
  box-shadow: 0 0 8px rgba(106, 17, 203, 0.4);
}

/* Input icons */
.input-icon {
  width: 20px;
  height: 20px;
  fill: #2575fc;
  margin-right: 10px;
}

/* Input fields */
input[type="text"] {
  border: none;
  outline: none;
  font-size: 1rem;
  padding: 0.55rem 0.5rem;
  flex: 1;
  border-radius: 12px;
  background: transparent;
  font-family: 'Poppins', sans-serif;
}

/* readonly styling for brand input */
input[readonly] {
  background: #e0e0e0;
  cursor: not-allowed;
  color: #707070;
}

/* Close Button */
.close-btn {
  position: absolute;
  top: 14px;
  right: 14px;
  background: transparent;
  border: none;
  font-size: 1.8rem;
  font-weight: 700;
  color: #6a11cb;
  cursor: pointer;
  transition: transform 0.2s ease;
  z-index: 10001; /* Pastikan close button di atas modal */
}

.close-btn:hover {
  transform: rotate(90deg);
  color: #2575fc;
}

/* Suggestions dropdown */
.suggestions-container {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
  max-height: 200px;
  overflow-y: auto;
  z-index: 10002; /* Pastikan suggestions di atas modal */
  display: none;
  border: 2px solid #2575fc;
  margin-top: 5px;
}

.suggestions-container.active {
  display: block;
}

.suggestion-item {
  padding: 10px 15px;
  cursor: pointer;
  border-bottom: 1px solid #eaeaea;
  transition: background-color 0.2s ease;
}

.suggestion-item:last-child {
  border-bottom: none;
}

.suggestion-item:hover {
  background-color: #f0f7ff;
}

.suggestion-item .product-name {
  font-weight: 600;
  font-size: 0.9rem;
}

.suggestion-item .product-brand {
  font-size: 0.8rem;
  color: #666;
}

/* Button container */
.button-container {
  display: flex;
  justify-content: center;
  margin-top: 1.5rem;
}

/* Process Button */
.process-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 0.8rem 1.5rem;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(37, 117, 252, 0.3);
  font-family: 'Poppins', sans-serif;
}

.process-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(37, 117, 252, 0.4);
}

.process-btn:active {
  transform: translateY(0);
}

.btn-icon {
  width: 20px;
  height: 20px;
  fill: white;
  margin-left: 8px;
}

/* Navigation Bar - Turunkan z-index agar berada di bawah modal */
nav.bottom-nav {
  flex-shrink: 0;
  background: var(--color-bg-light);
  box-shadow: 0 -1px 5px var(--color-shadow-light);
  display: flex;
  justify-content: space-around;
  padding: 0.4rem 0;
  border-top-left-radius: 14px;
  border-top-right-radius: 14px;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  max-width: 350px;
  margin-left: auto;
  margin-right: auto;
  z-index: 998; /* Turunkan z-index agar berada di bawah modal */
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

body.dark nav.bottom-nav {
  background: #1c1c1c;
  box-shadow: 0 -1px 8px var(--color-shadow-dark);
}

nav.bottom-nav button {
  background: transparent;
  border: none;
  color: var(--color-primary-light);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  padding: 4px 6px;
  user-select: none;
  transition: color 0.3s ease;
  flex-grow: 1;
  max-width: 120px;
  position: relative;
  z-index: 1;
  border-radius: 10px;
  transition: all 0.3s ease;
}

nav.bottom-nav button svg {
  width: 24px;
  height: 24px;
  stroke: var(--color-primary-light);
  stroke-width: 2;
  fill: none;
  margin-bottom: 2px;
  transition: stroke 0.3s ease;
}

nav.bottom-nav button:hover,
nav.bottom-nav button:focus {
  color: var(--color-primary-dark);
  outline: none;
}

nav.bottom-nav button:hover svg,
nav.bottom-nav button:focus svg {
  stroke: var(--color-primary-dark);
}

nav.bottom-nav button.scan-btn {
  background-color: var(--color-primary-light);
  color: white;
  flex-grow: 1.6;
  box-shadow: 0 6px 15px rgba(0, 123, 255, 0.7);
  transform: translateY(-14px);
  border-radius: 20px;
  z-index: 10; /* Tetap di dalam nav tapi tidak lebih tinggi dari modal */
  font-size: 0.8rem;
  font-weight: 700;
  transition: all 0.3s ease;
}

nav.bottom-nav button.scan-btn svg {
  stroke: white;
  margin-bottom: 6px;
  width: 28px;
  height: 28px;
}

nav.bottom-nav button.scan-btn:hover,
nav.bottom-nav button.scan-btn:focus {
  background-color: var(--color-primary-dark);
  box-shadow: 0 8px 20px rgba(0, 86, 179, 0.9);
  color: white;
  outline: none;
  transform: translateY(-16px) scale(1.05);
}

/* Full-size viewport untuk scanner */
.viewport-fullsize {
  width: 100%;
  min-height: 200px; /* Dikurangi dari 300px */
  max-height: 250px; /* Dikurangi dari 400px */
  border: 2px solid #ddd;
  border-radius: 8px;
  overflow: hidden;
  position: relative;
  background: #000;
  margin-bottom: 15px; /* Kurangi margin */
}

.viewport-fullsize.scanner-active {
  border-color: #4CAF50;
  box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
}

/* Pastikan video mengisi penuh container */
.viewport video,
.viewport-fullsize video {
  width: 100% !important;
  height: 100% !important;
  object-fit: cover; /* Memastikan video mengisi penuh tanpa distorsi */
}

.viewport canvas,
.viewport-fullsize canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100% !important;
  height: 100% !important;
}

/* Styling untuk container rekomendasi yang lebih baik */
.product-info {
  flex: 1;
}

.product-name {
  font-weight: 600;
  color: #2c3e50;
  margin-bottom: 4px;
  font-size: 14px;
}

.product-brand {
  color: #7f8c8d;
  font-size: 12px;
  margin-bottom: 2px;
}

.product-barcode {
  color: #95a5a6;
  font-size: 11px;
  font-family: 'Courier New', monospace;
}

.no-results {
  padding: 16px;
  text-align: center;
  color: #7f8c8d;
  font-style: italic;
}

.input-help {
  display: block;
  margin-top: 6px;
  color: #7f8c8d;
  font-size: 12px;
  font-style: italic;
}

/* Animation untuk scanner active */
@keyframes pulse-scanner {
  0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
  100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
}

.viewport-fullsize.scanner-active::before {
  content: '';
  position: absolute;
  top: 10px;
  right: 10px;
  width: 12px;
  height: 12px;
  background: #4CAF50;
  border-radius: 50%;
  animation: pulse-scanner 2s infinite;
  z-index: 10;
}

/* Responsif untuk mobile */
@media (max-width: 768px) {
  .modal {
    max-width: 95vw;
    padding: 16px;
  }
  
  .viewport-fullsize {
    min-height: 250px;
    max-height: 300px;
  }
  
  .suggestions-container {
    max-height: 200px;
  }
  
  .suggestion-item {
    padding: 10px 12px;
  }
  
  .product-name {
    font-size: 13px;
  }
}

/* Animation untuk scanner active */
@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
  100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
}

.viewport-fullsize.scanner-active::before {
  content: '';
  position: absolute;
  top: 10px;
  right: 10px;
  width: 12px;
  height: 12px;
  background: #4CAF50;
  border-radius: 50%;
  animation: pulse 2s infinite;
  z-index: 10;
}

/* Styling untuk overlay dan backdrop */
#overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(5px);
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

#overlay.active {
  opacity: 1;
  visibility: visible;
}

/* Close button styling */
.close-btn {
  position: absolute;
  top: 16px;
  right: 16px;
  background: none;
  border: none;
  font-size: 24px;
  color: #7f8c8d;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  transition: all 0.2s ease;
  z-index: 10;
}

.close-btn:hover {
  background: #f8f9fa;
  color: #2c3e50;
}
  </style>
</head>
<body>
  <div class="copyright-container">
    <a onclick="window.open('https://alfajrin23.github.io/Personal-Portofolio/')" class="copyright-link">
      <p class="copyright">by Al Fajrin A A &copy; 2025</p>
    </a>
  </div>

  <header>
    <a href="profilsetting.html" class="profile-photo" aria-label="Profile photo"></a>
    <div class="center-section">
      <a href="https://maps.app.goo.gl/fAhFceGrUhFyTBsDA" class="company-name">
        <h1>ABElektronik</h1>
      </a>
      <a href="https://maps.app.goo.gl/fAhFceGrUhFyTBsDA" class="company-address">
        <p>Jl. Raya Cirebon - Bandung No.1, Panjalin Kidul</p>
      </a>
    </div>
    <button class="btn-shutdown btn-animated" title="Close Application" aria-label="Close Application" onclick="handleShutdown()">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path d="M12 2v10M16.24 7.76a6 6 0 1 1-8.48 0" />
      </svg>
    </button>
  </header>

  <main>
    <div id="chart-scroll-container" aria-label="Grafik Bergulir">
      <div class="charts-wrapper">
        <div class="chart-box">
          <canvas id="chart1" aria-label="Grafik Pendapatan Harian" role="img"></canvas>
        </div>
        <div class="chart-box">
          <canvas id="chart2" aria-label="Grafik 10 Produk Terlaris" role="img"></canvas>
        </div>
      </div>
      <div class="indicators" id="indicators" role="tablist" aria-label="Chart indicators">
  <button class="indicator active" aria-selected="true" aria-controls="chart1" aria-label="Show chart 1: Daily Revenue" tabindex="0"></button>
  <button class="indicator" aria-selected="false" aria-controls="chart2" aria-label="Show chart 2: Top 10 Best-selling Products" tabindex="0"></button>
</div>
    </div>

    <div class="button-group" role="group" aria-label="Navigasi">
      <button type="button" class="btn-action data-barang btn-animated" title="Data Barang" aria-label="Data Barang" onclick="window.location.href='databarang.html'">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <rect x="3" y="5" width="18" height="14" rx="2" ry="2" />
          <path d="M3 10h18" />
        </svg>
        Data Barang
      </button>
      <button type="button" class="btn-action history-barang btn-animated" title="History Barang" aria-label="History Barang" onclick="window.location.href='history.html'">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <circle cx="12" cy="12" r="8" />
          <polyline points="12 6 12 12 16 14" />
        </svg>
        History Barang
      </button>
      <button type="button" class="btn-action laporan btn-animated" title="Laporan" aria-label="Laporan" onclick="window.location.href='laporan.html'">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M4 4h16v16H4z" />
          <path d="M8 9h8" />
          <path d="M8 13h5" />
          <path d="M8 17h5" />
        </svg>
        Laporan
      </button>
    </div>
  
    <!-- Revenue container positioned closer to navigation buttons -->
    <div class="revenue-container">
      <div class="revenue-display-wrapper">
        <div class="revenue-label">Pendapatan Hari Ini:</div>
        <div class="revenue-amount">Rp</div>
      </div>
    </div>
  </main>
  

<div id="overlay" class="overlay" aria-hidden="true">
  <div id="scanModal" class="modal" role="dialog" aria-modal="true">
    <button class="close-btn" id="closeModalBtn" aria-label="Tutup Modal" onclick="closeModal()">&times;</button>
    <h2 id="modalTitle">Scan Barcode Barang</h2>
    
    <!-- Video container for scanner -->
    <div id="interactive" class="viewport"></div>
    
    <form id="barcodeForm" autocomplete="off">
      <div class="subtitle" aria-label="Judul Transaksi Manual">
        <!-- Clipboard list icon with pulse animation -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M9 2H15V4H19C20.1 4 21 4.9 21 6V20C21 21.1 20.1 22 19 22H5C3.9 22 3 21.1 3 20V6C3 4.9 3.9 4 5 4H9V2ZM5 6V20H19V6H5ZM8 10H16V12H8V10ZM8 14H16V16H8V14Z"/>
        </svg>
        Transaksi Manual
      </div>

      <!-- Input nama barang dengan autocomplete -->
      <div class="input-group">
        <label for="namaBarang">Nama Barang</label>
        <div class="input-icon-wrapper">
          <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M21 16V8c0-.55-.45-1-1-1h-3V5a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v2H4c-.55 0-1 .45-1 1v8a3.98 3.98 0 0 0 2 3.46V21a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-1.54A3.98 3.98 0 0 0 21 16zm-6-5H9v-2h6v2zm4 5a2 2 0 1 1-4 0 2 2 0 0 1 4 0z"/>
          </svg>
          <input type="text" id="namaBarang" name="namaBarang" placeholder="Masukkan nama barang" onkeyup="searchProduct(this.value)" autocomplete="off" />
        </div>
        <!-- Container untuk daftar rekomendasi produk -->
        <div id="productSuggestions" class="suggestions-container"></div>
      </div>

      <!-- Input brand yang akan diisi otomatis -->
      <div class="input-group">
        <label for="brand">Brand</label>
        <div class="input-icon-wrapper">
          <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10a10 10 0 0 0 0-20zM8.5 11h1v3.5c0 .55.45 1 1 1s1-.45 1-1V11h1v3.5c0 1.38-1.12 2.5-2.5 2.5S8.5 15.88 8.5 14.5V11z"/>
          </svg>
          <input type="text" id="brand" name="brand" placeholder="Brand akan muncul otomatis" readonly />
        </div>
      </div>
      
      <!-- Tombol untuk memproses produk -->
      <div class="button-container">
        <button type="button" id="processProductBtn" class="process-btn" onclick="processSelectedProduct()">
          Proses Produk
          <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
          </svg>
        </button>
      </div>
    </form>
  </div>
</div>


  <nav class="bottom-nav" role="navigation" aria-label="Navigasi Bawah">
    <button class="btn-animated" title="Dashboard" aria-label="Dashboard" onclick="window.location.reload()"
>
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path d="M3 13h8V3H3v10zM13 21h8v-6h-8v6zM13 3v6h8V3h-8zM3 21h8v-4H3v4z" />
      </svg>
      Dashboard
    </button>
    <button class="scan-btn btn-animated" title="Scan Transaksi" aria-label="Scan Transaksi" onclick="openModal()">
    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <rect x="3" y="3" width="18" height="18" rx="3" ry="3" />
      <path d="M7 7h10M7 12h10M7 17h6" />
    </svg>
    Scan
  </button>
    <button class="btn-animated" title="Pengaturan" aria-label="Pengaturan" onclick="window.location.href='pengaturan.html'">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <circle cx="12" cy="12" r="3" />
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z" />
      </svg>
      Pengaturan
    </button>
  </nav>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

  <!-- Load Firebase SDK versi 8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- Load konfigurasi Firebase -->
  <script src="firebase-config.js"></script>

  <!-- Load Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
  // Pastikan untuk mengakses activeStoreId secara konsisten
  const activeStoreId = localStorage.getItem('activeStoreId');
  console.log('Active Store ID:', activeStoreId);

// Inisialisasi array untuk produk yang di-scan
window.scannedProducts = [];

  // Flag untuk menandai apakah scanner sedang berjalan
  /* let isScanning = false;  // Removed duplicate declaration */
  let selectedProductId = null;
  
window.addEventListener('DOMContentLoaded', async () => {
    // Ambil data toko aktif dari localStorage
    const activeStoreId = localStorage.getItem('activeStoreId');
    const storeName = localStorage.getItem('storeName') || 'Nama Toko';
    const storeAddress = localStorage.getItem('storeAddress') || 'Alamat Toko';
    const addressLink = localStorage.getItem('addressLink') || '#';

    const companyNameElem = document.querySelector('.company-name h1');
    const companyAddressElem = document.querySelector('.company-address p');
    const companyLinkElem = document.querySelector('.company-name');

    if (activeStoreId) {
        if (companyNameElem) companyNameElem.textContent = storeName;
        if (companyAddressElem) companyAddressElem.textContent = storeAddress;
        if (companyLinkElem) companyLinkElem.href = addressLink;

        // Memanggil fungsi untuk memperbarui grafik berdasarkan toko aktif
        await initCharts();
        await updateTodayRevenueDisplay();  // Pastikan ini dipanggil dengan await
    } else {
    // Tampilkan pesan atau default jika store belum dipilih
    console.warn('Store belum dipilih.');
    }
});


function onStoreSelected(store) {
  localStorage.setItem('activeStoreId', store.id);
  localStorage.setItem('storeName', store.name);
  localStorage.setItem('storeAddress', store.address);
  localStorage.setItem('addressLink', store.addressLink);
  window.location.href = 'index.html'; // refresh halaman agar data ter-update
}


const ctx1 = document.getElementById('chart1').getContext('2d');
const ctx2 = document.getElementById('chart2').getContext('2d');

let chart1, chart2;

// Fungsi untuk ambil data pendapatan harian 7 hari terakhir dari Firestore
async function fetchDailyRevenue(storeId) {
  const today = new Date();
  today.setHours(0,0,0,0);
  const days = [];
  const revenues = [];

  // Buat array tanggal 7 hari terakhir
  for(let i=6; i>=0; i--) {
    let d = new Date(today);
    d.setDate(d.getDate() - i);
    days.push(d);
    revenues.push(0);
  }

  try {
    const snapshot = await window.firebaseUtils.historyCollection
      .where('kategori', '==', 'keluar')
      .where('storeId', '==', storeId)
      .get();

    snapshot.forEach(doc => {
      const data = doc.data();
      if(data.tanggal && data.jumlah && data.harga) {
        const tDate = data.tanggal.toDate();
        for(let i=0; i<days.length; i++) {
          if(tDate.toDateString() === days[i].toDateString()) {
            revenues[i] += data.jumlah * data.harga;
            break;
          }
        }
      }
    });

    // Format label hari (Senin, Selasa, ...)
    const labels = days.map(d => d.toLocaleDateString('id-ID', { weekday: 'long' }));

    return { labels, revenues };
  } catch (error) {
    console.error('Error fetching daily revenue:', error);
    return { labels: [], revenues: [] };
  }
}

// Fungsi untuk ambil data 10 produk terlaris bulan ini dari Firestore
async function fetchTopProducts(storeId) {
  const now = new Date();
  const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

  try {
    const snapshot = await window.firebaseUtils.historyCollection
      .where('kategori', '==', 'keluar')
      .where('storeId', '==', storeId)
      .get();

    const productSales = {};

    snapshot.forEach(doc => {
      const data = doc.data();
      if(data.tanggal && data.namaBarang && data.jumlah) {
        const tDate = data.tanggal.toDate();
        if(tDate >= firstDay && tDate <= lastDay) {
          if(!productSales[data.namaBarang]) productSales[data.namaBarang] = 0;
          productSales[data.namaBarang] += data.jumlah;
        }
      }
    });

    // Sort produk berdasarkan jumlah terjual desc
    const sortedProducts = Object.entries(productSales)
      .sort((a,b) => b[1] - a[1])
      .slice(0, 10);

    const labels = sortedProducts.map(item => item[0]);
    const sales = sortedProducts.map(item => item[1]);

    return { labels, sales };
  } catch (error) {
    console.error('Error fetching top products:', error);
    return { labels: [], sales: [] };
  }
}

// Fungsi untuk inisialisasi dan update grafik
async function initCharts() {
  if (!activeStoreId) {
    console.warn("Toko belum dipilih.");
    return;
  }

  const dailyData = await fetchDailyRevenue(activeStoreId);
  const topProductData = await fetchTopProducts(activeStoreId);

  // Jika chart sudah ada, update datanya, jika belum buat baru
  if(chart1) {
    chart1.data.labels = dailyData.labels;
    chart1.data.datasets[0].data = dailyData.revenues;
    chart1.data.datasets[1].data = dailyData.revenues;
    chart1.update();
  } else {
    chart1 = new Chart(ctx1, {
      type: 'bar', // tipe utama bar
      data: {
        labels: dailyData.labels,
        datasets: [
          {
            type: 'bar',  // dataset bar
            label: 'Pendapatan Harian (Rp)',
            data: dailyData.revenues,
            backgroundColor: 'rgba(40, 167, 69, 0.7)',
            borderColor: 'rgba(40, 167, 69, 1)',
            borderWidth: 1,
            borderRadius: 6,
            maxBarThickness: 40
          },
          {
            type: 'line',  // dataset garis
            label: 'Trend Pendapatan',
            data: dailyData.revenues,
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 2,
            fill: false,
            tension: 0.3,  // garis smooth
            pointRadius: 4,
            pointBackgroundColor: 'rgba(255, 99, 132, 1)'
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {  // skala y versi Chart.js terbaru
            beginAtZero: true,
            ticks: {
              callback: val => 'Rp ' + val.toLocaleString('id-ID')
            }
          }
        },
        plugins: {
          tooltip: {
            enabled: true,
            mode: 'nearest',
            intersect: false,
            callbacks: {
              label: function(context) {
                const label = context.dataset.label || '';
                const value = context.parsed.y !== undefined ? context.parsed.y : context.parsed;
                return label + ': Rp ' + value.toLocaleString('id-ID');
              }
            }
          }
        }
      }
    });
  }


  if(chart2) {
    chart2.data.labels = topProductData.labels;
    chart2.data.datasets[0].data = topProductData.sales;
    chart2.update();
  } else {
    chart2 = new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: topProductData.labels,
        datasets: [{
          label: '10 Produk Terlaris Bulan Ini',
          data: topProductData.sales,
          backgroundColor: 'rgba(54, 162, 235, 0.7)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1,
          borderRadius: 6,
          maxBarThickness: 40
        }]
      },
      options: {
        responsive: true,
        indexAxis: 'y',
        scales: {
          xAxes: [{
            ticks: {
              beginAtZero: true
            }
          }]
        }
      }
    });
  }
}


// Panggil initCharts saat halaman dan Firebase siap
window.addEventListener('DOMContentLoaded', () => {
  if(activeStoreId && window.firebaseUtils && window.firebaseUtils.historyCollection) {
    initCharts();
  }
});



// Fungsi debug untuk memeriksa koneksi Firebase
async function debugFirebaseConnection() {
  console.log('=== DEBUG FIREBASE CONNECTION ===');
  
  try {
    // Cek apakah firebaseUtils tersedia
    if (!window.firebaseUtils) {
      console.error('window.firebaseUtils tidak tersedia');
      return false;
    }
    
    // Cek apakah productsCollection tersedia
    if (!window.firebaseUtils.productsCollection) {
      console.error('window.firebaseUtils.productsCollection tidak tersedia');
      return false;
    }
    
    // Test query sederhana
    const snapshot = await window.firebaseUtils.productsCollection.limit(5).get();
    console.log('Test query berhasil, jumlah dokumen:', snapshot.size);
    
    // Tampilkan sample data
    snapshot.forEach(doc => {
      const data = doc.data();
      console.log('Sample product:', {
        id: doc.id,
        namaBarang: data.namaBarang,
        brand: data.brand,
        storeId: data.storeId
      });
    });
    
    console.log('=== END DEBUG ===');
    return true;
    
  } catch (error) {
    console.error('Error dalam debug Firebase:', error);
    return false;
  }
}

// Panggil fungsi debug saat modal dibuka
function openModal() {
    console.log("Membuka modal scanner");
    
    // Debug Firebase connection
    debugFirebaseConnection();
    
    // Pastikan scanner tidak sedang berjalan
    stopQuaggaScanner();
    
    const overlay = document.getElementById('overlay');
    
    // Reset overlay content
    overlay.innerHTML = `
      <div id="scanModal" class="modal" role="dialog" aria-modal="true">
        <button class="close-btn" id="closeModalBtn" aria-label="Tutup Modal" onclick="closeModal()">&times;</button>
        <h2 id="modalTitle">Scan Barcode Barang</h2>
        
        <!-- Video container for scanner - FULL SIZE -->
        <div id="interactive" class="viewport-fullsize"></div>
        
        <form id="barcodeForm" autocomplete="off">
          <div class="subtitle" aria-label="Judul Transaksi Manual">
            <!-- Clipboard list icon with pulse animation -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M9 2H15V4H19C20.1 4 21 4.9 21 6V20C21 21.1 20.1 22 19 22H5C3.9 22 3 21.1 3 20V6C3 4.9 3.9 4 5 4H9V2ZM5 6V20H19V6H5ZM8 10H16V12H8V10ZM8 14H16V16H8V14Z"/>
            </svg>
            Transaksi Manual
          </div>

          <!-- Input pencarian produk (nama + brand) -->
          <div class="input-group">
            <label for="searchProduct">Cari Produk (Nama/Brand)</label>
            <div class="input-icon-wrapper">
              <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
              </svg>
              <input type="text" id="searchProduct" name="searchProduct" placeholder="Masukkan nama produk atau brand" autocomplete="off" />
            </div>
            <!-- Container untuk daftar rekomendasi produk -->
            <div id="productSuggestions" class="suggestions-container"></div>
          </div>

          <!-- Input barcode manual -->
          <div class="input-group">
            <label for="barcodeManual">Input Barcode Manual</label>
            <div class="input-icon-wrapper">
              <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path d="M2 6h1v12H2V6zm2 0h1v12H4V6zm2 0h1v12H6V6zm3 0h1v12H9V6zm2 0h2v12h-2V6zm3 0h1v12h-1V6zm2 0h2v12h-2V6zm4 0h1v12h-1V6zm2 0h1v12h-1V6z"/>
              </svg>
              <input type="text" id="barcodeManual" name="barcodeManual" placeholder="Masukkan nomor barcode" autocomplete="off" />
            </div>
            <small class="input-help">Gunakan jika scan kamera gagal atau tidak tersedia</small>
          </div>
          
          <!-- Tombol untuk memproses produk -->
          <div class="button-container">
            <button type="button" id="processProductBtn" class="process-btn" onclick="processSelectedProduct()">
              Proses Produk
              <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
              </svg>
            </button>
          </div>
        </form>
      </div>
    `;
    
    const modal = document.getElementById('scanModal');

    // Tampilkan overlay
    overlay.classList.add('active');
    overlay.setAttribute('aria-hidden', 'false');

    // Animasikan modal ke tengah layar dengan scale 1
    const centerLeft = (window.innerWidth - modal.offsetWidth) / 2;
    const centerTop = (window.innerHeight - modal.offsetHeight) / 2;

    modal.style.left = `${centerLeft}px`;
    modal.style.top = `${centerTop}px`;
    modal.classList.add('active');

    // Setup event listeners setelah elemen ada di DOM
    setupModalEventListeners();

    // Mulai scanner otomatis setelah modal tampil
    setTimeout(() => {
      startQuaggaScanner();
    }, 100);
  }

// Function untuk setup event listeners di modal
function setupModalEventListeners() {
  // Event listener untuk pencarian produk
  const searchInput = document.getElementById('searchProduct');
  if (searchInput) {
    // Gunakan input event untuk real-time search
    searchInput.addEventListener('input', function(e) {
      searchProduct(e.target.value);
    });
    
    // Tambah debounce untuk performa yang lebih baik
    let searchTimeout;
    searchInput.addEventListener('keyup', function(e) {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchProduct(e.target.value);
      }, 300);
    });
  }
  
  // Event listener untuk barcode manual
  const barcodeInput = document.getElementById('barcodeManual');
  if (barcodeInput) {
    barcodeInput.addEventListener('input', function(e) {
      searchByBarcode(e.target.value);
    });
    
    // Enter key untuk langsung process
    barcodeInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchByBarcode(e.target.value);
      }
    });
  }
}


  // Function untuk memulai scanner barcode - FULLSIZE
  function startQuaggaScanner() {
    console.log("Memulai scanner Quagga");
    
    if (isScanning) {
      console.log("Scanner sudah aktif, tidak perlu memulai ulang");
      return;
    }

    const scannerContainer = document.getElementById('interactive');
    if (!scannerContainer) {
      console.error("Elemen container scanner tidak ditemukan");
      return;
    }
    
    scannerContainer.style.display = 'block';

    Quagga.init({
      inputStream: {
        type: "LiveStream",
        constraints: {
          facingMode: "environment",
          width: { min: 640, ideal: 1280, max: 1920 },
          height: { min: 480, ideal: 720, max: 1080 },
          aspectRatio: { min: 1, max: 2 }
        },
        target: document.querySelector('#interactive'),
        area: { // Define scan area - reduced margins for fuller coverage
          top: "5%",
          right: "5%",
          left: "5%",
          bottom: "5%"
        }
      },
      decoder: {
        readers: [
          "code_128_reader",
          "ean_reader",
          "ean_8_reader",
          "code_39_reader",
          "upc_reader",
          "upc_e_reader"
        ],
        debug: {
          drawBoundingBox: true,
          showFrequency: false,
          drawScanline: true,
          showPattern: false
        }
      },
      locate: true
    }, function(err) {
      if (err) {
        console.error("Error initializing Quagga:", err);
        alert('Gagal menginisialisasi scanner: ' + err);
        return;
      }
      
      console.log("Quagga berhasil diinisialisasi");
      Quagga.start();
      isScanning = true;
      
      // Tambahkan indikator visual bahwa scanner aktif
      const viewportElement = document.querySelector('.viewport-fullsize');
      if (viewportElement) {
        viewportElement.classList.add('scanner-active');
      }
    });

    // PENTING: Pastikan event listener untuk deteksi barcode hanya didaftarkan sekali
    Quagga.offDetected(onBarcodeDetected);
    Quagga.onDetected(onBarcodeDetected);
  }

// Function untuk menghentikan scanner - IMPROVED VERSION
function stopQuaggaScanner() {
  if (!isScanning) return;

  try {
    Quagga.offDetected(onBarcodeDetected);
    Quagga.offProcessed(); // Menghentikan event onProcessed juga
    Quagga.stop();
    
    // Clear canvas
    const canvas = document.querySelector('#interactive canvas');
    if (canvas) {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    
  } catch (error) {
    console.error('Error stopping Quagga:', error);
  }
  
  isScanning = false;
  
  const scannerContainer = document.getElementById('interactive');
  if (scannerContainer) {
    scannerContainer.style.display = 'none';
  }
  
  // Hapus indikator visual
  const viewportElement = document.querySelector('.viewport-fullsize');
  if (viewportElement) {
    viewportElement.classList.remove('scanner-active');
  }
}

 // Function untuk menutup modal
  function closeModal() {
    console.log("Menutup modal scanner");
    
    // Hentikan scanner jika aktif
    stopQuaggaScanner();
    
    const overlay = document.getElementById('overlay');
    const scanModal = document.getElementById('scanModal');
    
    if (scanModal) {
      scanModal.classList.remove('active');
    }
    
    // PENTING: Jangan segera menghapus overlay, tunggu transisi selesai
    setTimeout(() => {
      if (overlay) {
        overlay.classList.remove('active');
        overlay.setAttribute('aria-hidden', 'true');
      }
    }, 300);
    
    // Reset variabel selectedProductId
    selectedProductId = null;
  }

// Fungsi pencarian produk realtime berdasarkan input nama ATAU brand
async function searchProduct(query) {
  const suggestionsContainer = document.getElementById('productSuggestions');
  
  if (!query || query.length < 1) {
    suggestionsContainer.innerHTML = '';
    suggestionsContainer.classList.remove('active');
    return;
  }
  
  try {
    query = query.toLowerCase().trim();
    console.log('Mencari produk dengan query:', query);

    // Tampilkan loading indicator
    suggestionsContainer.innerHTML = '<div class="loading-item">Mencari produk...</div>';
    suggestionsContainer.classList.add('active');

    const suggestions = [];

    // Debug activeStoreId
    console.log('Active Store ID:', window.activeStoreId || 'undefined');
    
    // Coba pendekatan yang lebih sederhana tanpa orderBy
    try {
      const snapshot = await window.firebaseUtils.productsCollection.get();
      
      console.log('Total documents:', snapshot.size);
      
      snapshot.forEach(doc => {
        const product = doc.data();
        product.id = doc.id;
        
        // Debug setiap produk
        console.log('Product data:', {
          id: product.id,
          nama: product.namaBarang,
          brand: product.brand,
          storeId: product.storeId
        });
        
        // Filter berdasarkan toko aktif (jika ada)
        const storeMatch = !window.activeStoreId || product.storeId === window.activeStoreId;
        
        // Filter berdasarkan query di nama atau brand
        const nameMatch = product.namaBarang && 
                         product.namaBarang.toLowerCase().includes(query);
        const brandMatch = product.brand && 
                          product.brand.toLowerCase().includes(query);
        
        console.log('Matches:', { storeMatch, nameMatch, brandMatch });
        
        if (storeMatch && (nameMatch || brandMatch)) {
          suggestions.push(product);
        }
      });
      
    } catch (dbError) {
      console.error("Firebase query error:", dbError);
      suggestionsContainer.innerHTML = '<div class="error-item">Error mengambil data produk</div>';
      return;
    }
    
    console.log('Jumlah produk ditemukan:', suggestions.length);
    
    // Tampilkan hasil
    if (suggestions.length > 0) {
      const limitedSuggestions = suggestions.slice(0, 8);
      let suggestionHTML = '';
      
      limitedSuggestions.forEach(product => {
        // Escape quotes dan handle undefined values
        const productName = (product.namaBarang || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
        const productBrand = (product.brand || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
        
        suggestionHTML += `
          <div class="suggestion-item" onclick="selectProduct('${product.id}', '${productName}', '${productBrand}')">
            <div class="product-info">
              <div class="product-name">${product.namaBarang || 'Nama tidak tersedia'}</div>
              <div class="product-brand">${product.brand || 'Tidak ada brand'}</div>
              ${product.barcode ? `<div class="product-barcode">Barcode: ${product.barcode}</div>` : ''}
            </div>
          </div>
        `;
      });
      
      suggestionsContainer.innerHTML = suggestionHTML;
      suggestionsContainer.classList.add('active');
    } else {
      suggestionsContainer.innerHTML = '<div class="no-results">Tidak ada produk ditemukan untuk "' + query + '"</div>';
      suggestionsContainer.classList.add('active');
    }
    
  } catch (error) {
    console.error("Error searching products:", error);
    suggestionsContainer.innerHTML = '<div class="error-item">Terjadi kesalahan saat mencari produk</div>';
    suggestionsContainer.classList.add('active');
  }
}

// Fungsi pencarian berdasarkan barcode manual
async function searchByBarcode(barcode) {
  if (!barcode || barcode.length < 3) {
    return;
  }
  
  try {
    console.log('Mencari produk dengan barcode:', barcode);
    
    // Cari produk berdasarkan barcode
    const snapshot = await window.firebaseUtils.productsCollection
      .where('barcode', '==', barcode)
      .get();
    
    if (!snapshot.empty) {
      const doc = snapshot.docs[0];
      const product = doc.data();
      product.id = doc.id;
      
      // Filter berdasarkan toko aktif jika ada
      if (!activeStoreId || product.storeId === activeStoreId) {
        // Otomatis pilih produk jika ditemukan
        selectProduct(product.id, product.namaBarang, product.brand || '');
        
        // Update field pencarian untuk menunjukkan hasil
        document.getElementById('searchProduct').value = `${product.namaBarang} - ${product.brand || 'No Brand'}`;
        
        // Beritahu user bahwa produk ditemukan
        const barcodeInput = document.getElementById('barcodeManual');
        barcodeInput.style.borderColor = '#4CAF50';
        setTimeout(() => {
          barcodeInput.style.borderColor = '';
        }, 2000);
      } else {
        console.log('Produk ditemukan tapi bukan dari toko aktif');
      }
    } else {
      // Jika tidak ditemukan, beri indikasi visual
      const barcodeInput = document.getElementById('barcodeManual');
      barcodeInput.style.borderColor = '#f44336';
      setTimeout(() => {
        barcodeInput.style.borderColor = '';
      }, 2000);
    }
  } catch (error) {
    console.error("Error searching by barcode:", error);
  }
}

// Fungsi ketika user memilih produk dari rekomendasi
function selectProduct(productId, productName, productBrand) {
  document.getElementById('searchProduct').value = `${productName} - ${productBrand || 'No Brand'}`;
  selectedProductId = productId;
  document.getElementById('productSuggestions').innerHTML = '';
  document.getElementById('productSuggestions').classList.remove('active');
  
  console.log('Produk dipilih:', productId, productName, productBrand);
}

// Event listener global untuk menutup daftar rekomendasi saat klik di luar
document.addEventListener('click', function(event) {
  const suggestionsContainer = document.getElementById('productSuggestions');
  const searchProductInput = document.getElementById('searchProduct');

  if (suggestionsContainer && !suggestionsContainer.contains(event.target) && event.target !== searchProductInput) {
    suggestionsContainer.innerHTML = '';
    suggestionsContainer.classList.remove('active');
  }
});

// Function helper untuk test data Firebase
async function testFirebaseData() {
  console.log('=== TESTING FIREBASE DATA ===');
  
  if (!window.firebaseUtils || !window.firebaseUtils.productsCollection) {
    console.error('Firebase utilities tidak tersedia');
    return;
  }
  
  try {
    const snapshot = await window.firebaseUtils.productsCollection.limit(3).get();
    console.log('Total dokumen dalam collection:', snapshot.size);
    
    if (snapshot.empty) {
      console.warn('Collection products kosong!');
      return;
    }
    
    snapshot.forEach((doc, index) => {
      const data = doc.data();
      console.log(`Dokumen ${index + 1}:`, {
        id: doc.id,
        namaBarang: data.namaBarang || 'TIDAK ADA',
        brand: data.brand || 'TIDAK ADA',
        storeId: data.storeId || 'TIDAK ADA',
        barcode: data.barcode || 'TIDAK ADA'
      });
    });
    
  } catch (error) {
    console.error('Error testing Firebase data:', error);
  }
  
  console.log('=== END TEST ===');
}

// Fungsi memproses produk yang dipilih (dari input nama atau scan barcode)
function processSelectedProduct() {
  if (!selectedProductId) {
    alert('Silakan pilih produk terlebih dahulu dari daftar rekomendasi, scan barcode, atau input barcode manual.');
    return;
  }
  
  window.firebaseUtils.productsCollection.doc(selectedProductId).get()
    .then(doc => {
      if (doc.exists) {
        const productData = doc.data();
        productData.id = doc.id;
        showProductDetailsModal(productData, doc.id);
      } else {
        alert('Produk tidak ditemukan.');
      }
    })
    .catch(error => {
      console.error("Error getting product:", error);
      alert('Terjadi kesalahan saat mengambil data produk.');
    });
}

// Function untuk menangani deteksi barcode
function onBarcodeDetected(result) {
  const code = result.codeResult.code;
  console.log("Barcode terdeteksi:", code);

  // Mencegah deteksi berulang dalam waktu singkat
  if (window.lastDetectedBarcode === code && Date.now() - window.lastDetectionTime < 2000) {
    return;
  }
  window.lastDetectedBarcode = code;
  window.lastDetectionTime = Date.now();

  stopQuaggaScanner();

  // Putar suara beep
  const audio = new Audio("https://cdnjs.cloudflare.com/ajax/libs/sound-effects/1.0.2/beep-29.mp3");
  audio.play();

  // Update field barcode manual dengan hasil scan
  document.getElementById('barcodeManual').value = code;

  // Ambil data produk berdasarkan barcode
  setTimeout(() => {
    fetchProductByBarcode(code);
  }, 300);
}

// Fungsi mengambil produk berdasarkan barcode
async function fetchProductByBarcode(barcode) {
    try {
        const snapshot = await window.firebaseUtils.productsCollection
            .where('barcode', '==', barcode)
            .where('storeId', '==', activeStoreId) // Tambahkan filter berdasarkan activeStoreId
            .limit(1)
            .get();
        
        if (snapshot.empty) {
            showProductNotFoundModal(barcode);
            return;
        }
        
        const doc = snapshot.docs[0];
        const productData = doc.data();
        productData.id = doc.id;
        
        stopQuaggaScanner();
        
        document.getElementById('namaBarang').value = productData.namaBarang || '';
        document.getElementById('brand').value = productData.brand || '';
        
        selectedProductId = doc.id;
        
    } catch (error) {
        console.error("Error fetching product:", error);
        alert("Terjadi kesalahan saat mengambil data produk. Silakan coba lagi.");
        startQuaggaScanner();
    }
}




  // Function untuk menghentikan scanner
  function stopQuaggaScanner() {
    console.log("Menghentikan scanner Quagga");
    
    try {
      if (isScanning && Quagga) {
        // Penting: Hapus event handler terlebih dahulu untuk mencegah multiple handlers
        Quagga.offDetected(onBarcodeDetected);
        Quagga.stop();
        console.log("Scanner berhasil dihentikan");
      }
    } catch (e) {
      console.error("Error saat menghentikan scanner:", e);
    }
    
    isScanning = false;
    
    // Hapus indikator visual bahwa scanner aktif
    const viewportElement = document.querySelector('.viewport');
    if (viewportElement) {
      viewportElement.classList.remove('scanner-active');
    }
  }

  // Function to fetch product data from Firebase by barcode
  async function fetchProductByBarcode(barcode) {
  try {
    // Query Firestore for the product with matching barcode
    const snapshot = await window.firebaseUtils.productsCollection
      .where('barcode', '==', barcode)
      .where('storeId', '==', activeStoreId)
      .limit(1)
      .get();
    
    if (snapshot.empty) {
      // No product found with this barcode
      showProductNotFoundModal(barcode);
      return;
    }
    
    // Get the first (and should be only) document
    const doc = snapshot.docs[0];
    const productData = doc.data();
    productData.id = doc.id; // Tambahkan ID dokumen ke data produk
    
    // PENTING: Pastikan scanner benar-benar berhenti sebelum menampilkan modal
    stopQuaggaScanner();
    
    // Tambahkan jeda sebelum menampilkan modal produk
    setTimeout(() => {
      // Show the product details modal
      showProductDetailsModal(productData, doc.id);
    }, 300);
    
  } catch (error) {
    console.error("Error fetching product:", error);
    alert("Terjadi kesalahan saat mengambil data produk. Silakan coba lagi.");
    
    // Restart scanner if there was an error
    startQuaggaScanner();
  }
}

  // Function to show product details modal with icons and adjusted position
function showProductDetailsModal(newProduct, newProductId) {
  // Tambahkan produk baru jika ada dan belum ada di list
  if (newProduct && newProductId) {
    const exists = window.scannedProducts.some(p => p.id === newProductId);
    if (!exists) {
      window.scannedProducts.push({ ...newProduct, id: newProductId, quantity: 1 });
    }
  }

  const overlay = document.getElementById('overlay');
  if (!overlay) return;

  // Bangun HTML untuk semua produk yang di-scan tanpa jenis transaksi dan total harga
  let productsHTML = '';
  window.scannedProducts.forEach((product, index) => {
    productsHTML += `
      <div class="product-details" style="margin-bottom: 20px;">
        <div class="product-info">
          <div class="product-info-row">
            <svg class="product-info-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
              <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
            <span class="product-info-label">Nama Barang:</span>
            <span>${product.namaBarang || '-'}</span>
          </div>
          <div class="product-info-row">
            <svg class="product-info-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
              <path d="M2 17l10 5 10-5"></path>
              <path d="M2 12l10 5 10-5"></path>
            </svg>
            <span class="product-info-label">Brand:</span>
            <span>${product.brand || '-'}</span>
          </div>
          <div class="product-info-row">
            <svg class="product-info-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            <span class="product-info-label">Harga:</span>
            <span>Rp ${product.harga.toLocaleString('id-ID')}</span>
          </div>
        </div>

        <div class="transaction-form">
          <div class="form-group">
            <label for="qty-${index}">Jumlah:</label>
            <input type="number" id="qty-${index}" min="1" max="${product.stok || 0}" value="${product.quantity}" class="form-control" oninput="updateProductQuantity(${index}, this.value)">
          </div>
          <div class="form-actions">
            <button class="btn-secondary" onclick="removeProductFromScanned(${index})" style="background-color:#dc3545; color:white;">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="button-icon">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              Hapus Produk
            </button>
          </div>
        </div>
      </div>
      <hr />
    `;
  });

  // Hitung total harga semua produk
  const totalPrice = window.scannedProducts.reduce((sum, p) => sum + (p.harga * p.quantity), 0);

  // Modal dengan jenis transaksi dan total harga di atas tombol
  const modalHTML = `
    <div id="productModal" class="modal product-modal" role="dialog" aria-modal="true" style="max-height: 90vh; overflow-y: auto;">
      <span class="close" onclick="closeProductModal()">&times;</span>
      <h2 style="text-align: center;">Detail Produk (${window.scannedProducts.length})</h2>
      ${productsHTML}

      <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border-radius: 8px;">
        <label for="transaction-type-select" style="font-weight: 600;">Jenis Transaksi:</label>
        <select id="transaction-type-select" class="form-control" onchange="updateTransactionType(this.value)" style="margin-bottom: 10px; width: 100%; padding: 8px; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc;">
          <option value="keluar">Barang Keluar (Penjualan)</option>
          <option value="masuk">Barang Masuk (Restock)</option>
        </select>

        <div class="total-section" style="text-align: center; font-weight: 700; font-size: 1.25rem; color: #27ae60;">
          Total Harga: <span class="total-price">Rp ${totalPrice.toLocaleString('id-ID')}</span>
        </div>
      </div>

      <div style="text-align: center; margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
        <button id="back-to-dashboard" class="btn-secondary" onclick="window.location.reload()">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="button-icon">
            <path d="M3 12h18M3 6h18M3 18h18"></path>
          </svg>
          Ke Dashboard
        </button>

        <button id="scan-more" class="btn-secondary" onclick="openScanForMore()">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="button-icon">
            <path d="M3 9h18v12H3z"></path>
            <path d="M21 9V3H3v6"></path>
            <line x1="12" y1="15" x2="12" y2="19"></line>
            <line x1="8" y1="13" x2="16" y2="13"></line>
          </svg>
          Tambah Transaksi
        </button>

        <button id="confirm-transaction" class="btn-primary" onclick="processAllTransactions()">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="button-icon">
            <path d="M5 13l4 4L19 7"></path>
          </svg>
          Proses
        </button>
      </div>
    </div>
  `;

  overlay.innerHTML = modalHTML;
  overlay.classList.add('active');
  overlay.setAttribute('aria-hidden', 'false');

  // Default jenis transaksi adalah 'keluar'
  window.currentTransactionType = 'keluar';

  setTimeout(() => {
    const modal = document.getElementById('productModal');
    if (!modal) return;
    const centerLeft = (window.innerWidth - modal.offsetWidth) / 2;
    const centerTop = (window.innerHeight * 0.4) - (modal.offsetHeight / 2);
    modal.style.left = `${centerLeft}px`;
    modal.style.top = `${centerTop}px`;
    modal.classList.add('active');
  }, 10);
}

updateTotalPriceDisplay();


// Update quantity produk di scannedProducts
function updateProductQuantity(index, value) {
  let qty = parseInt(value);
  if (isNaN(qty) || qty < 1) {
    qty = 1; // minimal 1
  }
  
  const maxStock = window.scannedProducts[index].stok || 0;
  if (qty > maxStock) {
    alert(`Jumlah melebihi stok tersedia (${maxStock}).`);
    qty = maxStock;
  }
  
  window.scannedProducts[index].quantity = qty;
  
  // Update nilai input jika ada koreksi
  const inputElem = document.getElementById(`qty-${index}`);
  if (inputElem) {
    inputElem.value = qty;
  }
  
  // Update total harga keseluruhan
  updateTotalPriceDisplay();
}



// Update jenis transaksi produk di scannedProducts
function updateTransactionType(value) {
  window.currentTransactionType = value;
}


// Update total price text for a product in modal
function updateProductDetailsTotalPrice(index) {
  const product = window.scannedProducts[index];
  const modal = document.getElementById('productModal');
  if (!modal) return;
  const totalPriceElements = modal.querySelectorAll('.total-price');
  if (totalPriceElements[index]) {
    totalPriceElements[index].textContent = `Rp ${(product.harga * product.quantity).toLocaleString('id-ID')}`;
  }
}

// Hapus produk dari scannedProducts dan refresh modal
function removeProductFromScanned(index) {
  window.scannedProducts.splice(index, 1);
  if (window.scannedProducts.length === 0) {
    closeProductModal();
  } else {
    showProductDetailsModal();
  }
}

function updateTotalPriceDisplay() {
  const totalPrice = window.scannedProducts.reduce((sum, p) => sum + (p.harga * p.quantity), 0);
  const totalPriceElement = document.querySelector('.total-price');
  if (totalPriceElement) {
    totalPriceElement.textContent = `Rp ${totalPrice.toLocaleString('id-ID')}`;
  }
}



async function processAllTransactions() {
  if (!window.scannedProducts || window.scannedProducts.length === 0) {
    alert('Tidak ada produk yang diproses.');
    return;
  }

  try {
    const batch = firebase.firestore().batch();

    for (const p of window.scannedProducts) {
      const productRef = window.firebaseUtils.productsCollection.doc(p.id);

      let newStock;
      if (window.currentTransactionType === 'keluar') {
        if (p.quantity > p.stok) {
          alert(`Stok tidak cukup untuk produk ${p.namaBarang}. Stok tersedia: ${p.stok}`);
          return;
        }
        newStock = p.stok - p.quantity;
      } else {
        newStock = p.stok + p.quantity;
      }

      batch.update(productRef, { stok: newStock });

      const historyData = {
      tanggal: firebase.firestore.Timestamp.now(),
      namaBarang: p.namaBarang,
      brand: p.brand || '',
      kategori: window.currentTransactionType,
      jumlah: p.quantity,
      harga: p.harga,  // Tambahkan harga produk di sini
      keterangan: `Transaksi via Scan Barcode`,
      storeId: activeStoreId,
      oleh: 'Aplikasi Scan'
    };
    batch.set(historyRef, historyData);


    }

    await batch.commit();

    alert(`Transaksi untuk ${window.scannedProducts.length} produk berhasil diproses!`);

    window.scannedProducts = [];
    closeProductModal();

    updateTodayRevenueDisplay();

  } catch (error) {
    console.error('Error processing transactions:', error);
    alert('Terjadi kesalahan saat memproses transaksi. Silakan coba lagi.');
  }
}



// Function to directly open scanner for scanning additional products
function openScanForMore() {
  console.log("Memulai scan untuk produk tambahan");
  
  // Close the current product modal
  closeProductModal();
  
  // Short delay to ensure previous modal is fully closed
  setTimeout(() => {
    // Buat dan tampilkan overlay scanner
    openModal(); // Gunakan fungsi yang sudah ada
  }, 300);
}

// Create a scanner overlay with camera display
function createScannerOverlay() {
  const overlay = document.getElementById('overlay');
  
  // Create the scanner modal HTML
  const scannerHTML = `
    <div id="scannerModal" class="modal scanner-modal" role="dialog" aria-modal="true">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 style="text-align: center;">Scan Barcode</h2>
      
      <div class="scanner-container">
        <div class="viewport scanner-active">
          <video id="scanner-preview" autoplay playsinline></video>
          <canvas id="scanner-canvas" class="scanner-canvas"></canvas>
          <div class="scan-region-highlight"></div>
          <div class="scan-region-highlight-svg"></div>
        </div>
        
        <div class="controls">
          <button id="toggle-flash" class="btn-icon">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="button-icon">
              <path d="M9 2l-7 11h6l-3 9 9-13h-6l4-7z"></path>
            </svg>
            Flash
          </button>
          
          <button id="change-camera" class="btn-icon">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="button-icon">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
              <circle cx="12" cy="13" r="4"></circle>
            </svg>
            Kamera
          </button>
        </div>
        
        <div class="scanner-info">
          <p>Posisikan barcode di dalam area scan</p>
        </div>
      </div>
    </div>
  `;
  
  // Create temporary element to parse the HTML string
  const temp = document.createElement('div');
  temp.innerHTML = scannerHTML;
  const scannerModal = temp.firstElementChild;
  
  // Add the modal to the overlay
  overlay.innerHTML = '';
  overlay.appendChild(scannerModal);
  
  // Show the overlay and modal
  overlay.classList.add('active');
  overlay.setAttribute('aria-hidden', 'false');
  
  // Animate modal to center of screen
  setTimeout(() => {
    const modal = document.getElementById('scannerModal');
    modal.classList.add('active');
    
    // Set up event listeners for the scanner controls
    setupScannerControls();
  }, 10);
}

// Initialize the barcode scanner
function initializeScanner() {
  const preview = document.getElementById('scanner-preview');
  
  // Check if we already have Quagga initialized
  if (window.Quagga && window.Quagga.initialized) {
    window.Quagga.stop();
  }

  // Initialize Quagga with proper configuration
  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: preview,
      constraints: {
        facingMode: "environment" // Use back camera by default
      },
    },
    locator: {
      patchSize: "medium",
      halfSample: true
    },
    numOfWorkers: 2,
    frequency: 10,
    decoder: {
      readers: ["ean_reader", "ean_8_reader", "code_128_reader", "code_39_reader", "code_93_reader", "upc_reader", "upc_e_reader"]
    },
    locate: true
  }, function(err) {
    if (err) {
      console.error("Error initializing Quagga:", err);
      showScannerError("Tidak dapat mengakses kamera. Pastikan browser memiliki izin kamera.");
      return;
    }
    
    // Mark Quagga as initialized
    window.Quagga.initialized = true;
    
    // Start the scanner
    Quagga.start();
    
    // Add detection event listener
    Quagga.onDetected(handleBarcodeDetection);
    
    // Show scanner is active
    document.querySelector('.viewport').classList.add('scanner-active');
  });
}

// Handle barcode detection
function handleBarcodeDetection(result) {
  // Check the result code certainty - only accept codes above a certain threshold
  if (result.codeResult.startInfo.error <= 0.25) {
    // Get the barcode
    const barcode = result.codeResult.code;
    
    // Stop the scanner
    Quagga.stop();
    window.Quagga.initialized = false;
    
    // Show a loading indicator
    showScanningResult(barcode, "Mencari produk...");
    
    // Search for the barcode in the database
    searchProductByBarcode(barcode);
  }
}

// Function to search for a product by barcode
function searchProductByBarcode(barcode) {
  if (!window.firebaseUtils || !window.firebaseUtils.productsCollection) {
    console.error("Firebase utils not initialized.");
    showScannerError("Terjadi kesalahan koneksi database.");
    return;
  }
  
  // Query Firestore for the barcode
  window.firebaseUtils.productsCollection
    .where("barcode", "==", barcode)
    .limit(1)
    .get()
    .then((querySnapshot) => {
      if (querySnapshot.empty) {
        // No product found with this barcode
        showProductNotFoundModal(barcode);
      } else {
        // Get product data
        const doc = querySnapshot.docs[0];
        const product = doc.data();
        
        // Show product details modal
        showProductDetailsModal(product, doc.id);
      }
    })
    .catch((error) => {
      console.error("Error searching for product:", error);
      showScannerError("Terjadi kesalahan saat mencari produk.");
    });
}

// Setup controls for the scanner
function setupScannerControls() {
  // Toggle flash button
  const flashButton = document.getElementById('toggle-flash');
  if (flashButton) {
    flashButton.addEventListener('click', toggleFlash);
  }
  
  // Change camera button
  const cameraButton = document.getElementById('change-camera');
  if (cameraButton) {
    cameraButton.addEventListener('click', toggleCamera);
  }
}

// Toggle the flash/torch
function toggleFlash() {
  const track = getVideoTrack();
  if (!track) return;
  
  const capabilities = track.getCapabilities();
  if (!capabilities.torch) {
    showToast("Perangkat ini tidak mendukung flash.");
    return;
  }
  
  // Get current status
  const currentTorch = window.scannerSettings?.torch || false;
  
  // Toggle torch
  track.applyConstraints({ advanced: [{ torch: !currentTorch }] })
    .then(() => {
      // Store the new setting
      if (!window.scannerSettings) window.scannerSettings = {};
      window.scannerSettings.torch = !currentTorch;
      
      // Update button appearance
      const flashButton = document.getElementById('toggle-flash');
      if (flashButton) {
        if (window.scannerSettings.torch) {
          flashButton.classList.add('active');
        } else {
          flashButton.classList.remove('active');
        }
      }
    })
    .catch(err => {
      console.error("Error toggling flash:", err);
      showToast("Tidak dapat mengaktifkan flash.");
    });
}

// Toggle between front and back cameras
function toggleCamera() {
  if (!window.scannerSettings) window.scannerSettings = {};
  
  // Toggle the facing mode
  window.scannerSettings.facingMode = 
    window.scannerSettings.facingMode === "environment" ? "user" : "environment";
  
  // Stop current scanner
  Quagga.stop();
  
  // Reinitialize with new camera
  setTimeout(() => {
    // Initialize Quagga with the new facing mode
    Quagga.init({
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: document.getElementById('scanner-preview'),
        constraints: {
          facingMode: window.scannerSettings.facingMode
        },
      },
      locator: {
        patchSize: "medium",
        halfSample: true
      },
      numOfWorkers: 2,
      frequency: 10,
      decoder: {
        readers: ["ean_reader", "ean_8_reader", "code_128_reader", "code_39_reader", "code_93_reader", "upc_reader", "upc_e_reader"]
      },
      locate: true
    }, function(err) {
      if (err) {
        console.error("Error reinitializing camera:", err);
        showToast("Gagal mengganti kamera.");
        
        // Revert the setting
        window.scannerSettings.facingMode = 
          window.scannerSettings.facingMode === "environment" ? "user" : "environment";
        return;
      }
      
      // Start the scanner
      Quagga.start();
      
      // Add detection event listener
      Quagga.onDetected(handleBarcodeDetection);
      
      // Show which camera is active
      showToast(`Menggunakan kamera ${window.scannerSettings.facingMode === "environment" ? "belakang" : "depan"}`);
    });
  }, 300);
}

// Helper function to get current video track
function getVideoTrack() {
  const videoElement = document.getElementById('scanner-preview');
  if (!videoElement) return null;
  
  const stream = videoElement.srcObject;
  if (!stream) return null;
  
  const tracks = stream.getVideoTracks();
  return tracks.length > 0 ? tracks[0] : null;
}

// Show scanner error message
function showScannerError(message) {
  const scannerInfo = document.querySelector('.scanner-info');
  if (scannerInfo) {
    scannerInfo.innerHTML = `<p class="error-message">${message}</p>
      <button class="btn-primary" onclick="closeModal(); setTimeout(() => window.location.href='index.html', 300);">
        Kembali ke Dashboard
      </button>`;
  }
}

// Show scanning result
function showScanningResult(barcode, message) {
  const scannerInfo = document.querySelector('.scanner-info');
  if (scannerInfo) {
    scannerInfo.innerHTML = `
      <div class="scanning-result">
        <div class="barcode-display">${barcode}</div>
        <p>${message}</p>
        <div class="loader"></div>
      </div>
    `;
  }
}

// Function to close modal (compatible with existing code)
function closeModal() {
  const overlay = document.getElementById('overlay');
  const scannerModal = document.getElementById('scannerModal');
  
  // Stop Quagga if it's running
  if (window.Quagga && window.Quagga.initialized) {
    window.Quagga.stop();
    window.Quagga.initialized = false;
  }
  
  if (scannerModal) {
    scannerModal.classList.remove('active');
  }
  
  // After transition, hide overlay
  setTimeout(() => {
    overlay.classList.remove('active');
    overlay.setAttribute('aria-hidden', 'true');
    overlay.innerHTML = '';
  }, 300);
}

// Add additional CSS styles for the scanner modal
const scannerStyleElement = document.createElement('style');
scannerStyleElement.textContent = `
  /* Scanner modal styles */
  .scanner-modal {
    width: 95%;
    max-width: 500px;
    padding: 15px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    overflow: hidden;
  }
  
  body.dark .scanner-modal {
    background: #222;
    color: #eee;
  }
  
  .scanner-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 10px;
  }
  
  .viewport {
    width: 100%;
    height: 60vh;
    max-height: 150px;
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    background-color: #000;
  }
  
  #scanner-preview {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .scanner-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2;
  }
  
  .scan-region-highlight {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 70%;
    height: 30%;
    border: 2px solid rgba(255, 0, 0, 0.5);
    border-radius: 10px;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
    z-index: 1;
  }
  
  .scan-region-highlight::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: red;
    animation: scan 2s linear infinite;
  }
  
  @keyframes scan {
    0% { top: 0; }
    50% { top: 100%; }
    100% { top: 0; }
  }
  
  .controls {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 15px;
  }
  
  .btn-icon {
    background: #007bff;
    color: white;
    border: none;
    border-radius: 50px;
    padding: 8px 15px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .btn-icon:hover {
    background: #0069d9;
    transform: translateY(-2px);
  }
  
  .btn-icon.active {
    background: #ffc107;
    color: #000;
  }
  
  .btn-icon .button-icon {
    width: 16px;
    height: 16px;
    stroke: currentColor;
    stroke-width: 2;
    fill: none;
  }
  
  .scanner-info {
    text-align: center;
    margin-top: 15px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 8px;
    min-height: 60px;
    width: 100%;
  }
  
  body.dark .scanner-info {
    background: rgba(255, 255, 255, 0.1);
  }
  
  .scanner-info p {
    margin: 0;
    font-size: 14px;
    color: #555;
  }
  
  body.dark .scanner-info p {
    color: #bbb;
  }
  
  .error-message {
    color: #d9534f !important;
    font-weight: 500;
  }
  
  .scanning-result {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }
  
  .barcode-display {
    font-size: 18px;
    font-weight: 600;
    color: #007bff;
    background: rgba(0, 123, 255, 0.1);
    padding: 5px 15px;
    border-radius: 20px;
  }
  
  body.dark .barcode-display {
    color: #3399ff;
    background: rgba(51, 153, 255, 0.2);
  }
  
  .loader {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(0, 123, 255, 0.2);
    border-top: 3px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  body.dark .loader {
    border-color: rgba(51, 153, 255, 0.2);
    border-top-color: #3399ff;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  
`;

document.head.appendChild(scannerStyleElement);

// Tambahkan fungsi untuk melacak instance scanner
function initQuagga() {
  // Konfigurasi dan inisialisasi Quagga
  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: document.querySelector('#scanner .viewport'),
      constraints: {
        width: { min: 450 },
        height: { min: 300 },
        facingMode: "environment",
        aspectRatio: { min: 1, max: 2 }
      },
    },
    locator: {
      patchSize: "medium",
      halfSample: true
    },
    numOfWorkers: 2,
    frequency: 10,
    decoder: {
      readers: ["ean_reader", "ean_8_reader", "code_128_reader"]
    },
    locate: true
  }, function(err) {
    if (err) {
      console.error("Error initializing Quagga:", err);
      alert("Gagal menginisialisasi scanner kamera. Periksa izin kamera Anda.");
      return;
    }
    
    console.log("Quagga initialized successfully");
    
    // Tandai viewport sebagai scanner aktif
    const viewport = document.querySelector('#scanner .viewport');
    if (viewport) {
      viewport.classList.add('scanner-active');
    }
    
    // Simpan referensi bahwa scanner aktif
    window.quaggaInstance = true;
    
    // Mulai scanner
    Quagga.start();
  });
  
  // Tambahkan event listener untuk deteksi barcode
  Quagga.onDetected(handleBarcodeDetection);
}

// Fungsi untuk menangani deteksi barcode
function handleBarcodeDetection(result) {
  if (result && result.codeResult) {
    // Hindari multiple detection dengan debounce sederhana
    if (window.lastDetection && Date.now() - window.lastDetection < 1500) {
      return;
    }
    window.lastDetection = Date.now();
    
    const barcode = result.codeResult.code;
    console.log("Barcode detected:", barcode);
    
    // Hentikan scanner setelah deteksi
    if (window.quaggaInstance) {
      Quagga.stop();
      window.quaggaInstance = null;
    }
    
    // Proses barcode yang terdeteksi
    processDetectedBarcode(barcode);
  }
}

// Fungsi untuk memproses barcode yang terdeteksi
function processDetectedBarcode(barcode) {
  // Cari produk dengan barcode tersebut di Firestore
  window.firebaseUtils.productsCollection
    .where("barcode", "==", barcode)
    .get()
    .then((querySnapshot) => {
      if (!querySnapshot.empty) {
        // Produk ditemukan
        const productDoc = querySnapshot.docs[0];
        const productData = productDoc.data();
        
        // Tampilkan modal detail produk
        showProductDetailsModal(productData, productDoc.id);
      } else {
        // Produk tidak ditemukan
        showProductNotFoundModal(barcode);
      }
    })
    .catch((error) => {
      console.error("Error fetching product:", error);
      alert("Terjadi kesalahan saat mencari produk. Silakan coba lagi.");
      
      // Buka kembali scanner jika terjadi error
      setTimeout(() => {
        if (!window.quaggaInstance) {
          initQuagga();
        }
      }, 1000);
    });
}
// Function to handle multiple product scan session
// This maintains a cart of scanned products
function initMultiProductScan() {
  // Initialize cart if it doesn't exist
  if (!window.scanCart) {
    window.scanCart = {
      items: [],
      totalAmount: 0
    };
  }
}

// Function to add product to cart
function addProductToCart(product, quantity, transactionType) {
  initMultiProductScan();
  
  // Calculate item total
  const itemTotal = product.harga * quantity;
  
  // Add to cart
  window.scanCart.items.push({
    productId: product.id,
    name: product.namaBarang,
    brand: product.brand || '',
    price: product.harga,
    quantity: quantity,
    transactionType: transactionType,
    itemTotal: itemTotal
  });
  
  // Update cart total
  window.scanCart.totalAmount += itemTotal;
  
  // Optional: Show toast or notification that item was added to cart
  showToast(`${product.namaBarang} ditambahkan ke keranjang`);
}

// Show a toast notification
function showToast(message) {
  // Create toast element if it doesn't exist
  let toast = document.getElementById('scan-toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'scan-toast';
    toast.className = 'scan-toast';
    document.body.appendChild(toast);
    
    // Add toast styles if not already in document
    if (!document.getElementById('toast-styles')) {
      const toastStyles = document.createElement('style');
      toastStyles.id = 'toast-styles';
      toastStyles.textContent = `
        .scan-toast {
          position: fixed;
          bottom: 80px;
          left: 50%;
          transform: translateX(-50%);
          background-color: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 10px 20px;
          border-radius: 20px;
          font-size: 14px;
          z-index: 2000;
          opacity: 0;
          transition: opacity 0.3s ease;
          max-width: 280px;
          text-align: center;
          box-shadow: 0px 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        .scan-toast.visible {
          opacity: 1;
        }
      `;
      document.head.appendChild(toastStyles);
    }
  }
  
  // Set message and show toast
  toast.textContent = message;
  toast.classList.add('visible');
  
  // Hide after 2 seconds
  setTimeout(() => {
    toast.classList.remove('visible');
  }, 2000);
}

  // Function to show "product not found" modal
  function showProductNotFoundModal(barcode) {
    // Close the scanner modal first
    closeModal();
    
    // Create a new modal for "product not found"
    const overlay = document.getElementById('overlay');
    
    // Create the modal HTML
    const modalHTML = `
      <div id="notFoundModal" class="modal not-found-modal" role="dialog" aria-modal="true">
        <span class="close" onclick="closeProductModal()">&times;</span>
        <h2 style="text-align: center;">Produk Tidak Ditemukan</h2>
        
        <div class="not-found-content">
          <p>Barcode <strong>${barcode}</strong> tidak ditemukan dalam database.</p>
          <p>Apakah Anda ingin menambahkan produk baru dengan barcode ini?</p>
          
          <div class="form-actions">
            <button class="btn-secondary" onclick="closeProductModal()">Batal</button>
            <button class="btn-primary" onclick="redirectToAddProduct('${barcode}')">Tambah Produk Baru</button>
          </div>
        </div>
      </div>
    `;
    
    // Create temporary element to parse the HTML string
    const temp = document.createElement('div');
    temp.innerHTML = modalHTML;
    const notFoundModal = temp.firstElementChild;
    
    // Add the modal to the overlay
    overlay.innerHTML = '';
    overlay.appendChild(notFoundModal);
    
    // Show the overlay and modal
    overlay.classList.add('active');
    overlay.setAttribute('aria-hidden', 'false');
    
    // Animate modal to center of screen
    setTimeout(() => {
      const modal = document.getElementById('notFoundModal');
      const centerLeft = (window.innerWidth - modal.offsetWidth) / 2;
      const centerTop = (window.innerHeight - modal.offsetHeight) / 2;
      
      modal.style.left = `${centerLeft}px`;
      modal.style.top = `${centerTop}px`;
      modal.classList.add('active');
    }, 10);
  }

  // Function to close product modal
  function closeProductModal() {
  console.log("Menutup modal produk");
  
  const overlay = document.getElementById('overlay');
  const productModal = document.getElementById('productModal') || document.getElementById('notFoundModal');
  
  if (productModal) {
    productModal.classList.remove('active');
  }
  
  // PENTING: Tambahkan jeda yang cukup sebelum menghapus overlay
  setTimeout(() => {
    if (overlay) {
      overlay.classList.remove('active');
      overlay.setAttribute('aria-hidden', 'true');
    }
  }, 300);
}

  // Function to update total price based on quantity
  function updateTotalPrice(unitPrice) {
    const qtyInput = document.getElementById('qty');
    const totalPriceElement = document.querySelector('.total-price');
    
    if (qtyInput && totalPriceElement) {
      const qty = parseInt(qtyInput.value) || 0;
      const totalPrice = qty * unitPrice;
      totalPriceElement.textContent = `Rp ${totalPrice.toLocaleString('id-ID')}`;
    }
  }

  // Function to process the transaction
async function processTransaction(productId) {
  const qtyInput = document.getElementById('qty');
  const transactionTypeSelect = document.getElementById('transaction-type');
  
  if (!qtyInput || !transactionTypeSelect || !window.currentProduct) {
    alert('Terjadi kesalahan. Silakan coba lagi.');
    return;
  }
  
  const qty = parseInt(qtyInput.value) || 0;
  const transactionType = transactionTypeSelect.value;
  
  if (qty <= 0) {
    alert('Jumlah harus lebih dari 0.');
    return;
  }
  
  // For outgoing transactions (sales), check if there is enough stock
  if (transactionType === 'keluar' && qty > window.currentProduct.stok) {
    alert(`Stok tidak mencukupi. Stok tersedia: ${window.currentProduct.stok}`);
    return;
  }
  
  try {
    // Start a Firestore batch operation
    const batch = firebase.firestore().batch();
    
    // 1. Update product stock
    const productRef = window.firebaseUtils.productsCollection.doc(productId);
    const newStock = transactionType === 'keluar' 
      ? window.currentProduct.stok - qty 
      : window.currentProduct.stok + qty;
    
    batch.update(productRef, { stok: newStock });
    
    // 2. Add transaction to history
    const historyRef = window.firebaseUtils.historyCollection.doc();
    const historyData = {
      barcode: window.currentProduct.barcode || '',
      tanggal: firebase.firestore.Timestamp.now(),
      namaBarang: window.currentProduct.namaBarang,
      brand: window.currentProduct.brand || '',
      kategori: transactionType,
      jumlah: qty,
      keterangan: `Transaksi via Scan Barcode`,
      storeId: activeStoreId,
      oleh: 'Aplikasi Scan'
    };
    
    batch.set(historyRef, historyData);
    
    // Commit the batch
    await batch.commit();
    
    // Show success message with options
    const scanAgain = confirm(`Transaksi berhasil diproses! ${qty} barang telah ${transactionType === 'keluar' ? 'terjual' : 'ditambahkan'}.\n\nApakah Anda ingin melanjutkan scan produk lainnya?`);
    
    // Close the current product modal
    closeProductModal();
    
    // If the user wants to scan again, open the scanner modal
    if (scanAgain) {
      // Short delay to ensure previous modal is fully closed
      setTimeout(() => {
        openModal(); // Open scanner modal
      }, 300);
    } else {
      // If we're on the dashboard, update the revenue display
      if (window.location.pathname.includes('index.html') || window.location.pathname === '/') {
        updateTodayRevenueDisplay();
      }
    }
    
  } catch (error) {
    console.error('Error processing transaction:', error);
    alert('Terjadi kesalahan saat memproses transaksi. Silakan coba lagi.');
  }
}

  // Function to redirect to add product page with barcode prefilled
  function redirectToAddProduct(barcode) {
    // Store the barcode in sessionStorage so it can be accessed on the add product page
    sessionStorage.setItem('newProductBarcode', barcode);
    
    // Redirect to the add product page
    window.location.href = 'tambahbarang.html';
  }

const fixedStyleElement = document.createElement('style');
fixedStyleElement.textContent = `
  /* Tambahan styles untuk memperbaiki transisi modal */
  .modal {
    transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
    transform: scale(0.8);
    opacity: 0;
    position: fixed;
    z-index: 1000;
  }
  
  .modal.active {
    transform: scale(1);
    opacity: 1;
  }
  
  #overlay {
    transition: opacity 0.3s ease-in-out;
    opacity: 0;
    visibility: hidden;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 999;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  #overlay.active {
    opacity: 1;
    visibility: visible;
  }
  
  /* Tambahan untuk memastikan modal produk terlihat dengan baik */
  .product-modal {
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    padding: 15px;
  }
  
  body.dark .product-modal {
    background: #222;
    color: #eee;
  }
`;

document.head.appendChild(fixedStyleElement);

  // Add CSS styles for the product modal
const styleElement = document.createElement('style');
styleElement.textContent = `
  /* Add these styles to your existing CSS to support the product modal enhancements */
  .product-modal {
  width: 90%;
  max-width: 380px;
  padding: 20px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

body.dark .product-modal {
  background: #222;
  color: #eee;
}

.product-details {
  margin-top: 20px;
}

/* Updated product info styling with row layout for icons */
.product-info {
  background: #f5f5f5;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  border-left: 4px solid #007bff;
}

body.dark .product-info {
  background: #333;
  border-left-color: #3399ff;
}

/* New row style for each product info item */
.product-info-row {
  display: flex;
  align-items: center;
  margin: 12px 0;
  font-size: 0.9rem;
}

/* Styling for the icons */
.product-info-icon {
  width: 20px;
  height: 20px;
  margin-right: 8px;
  stroke: #007bff;
  stroke-width: 2;
  fill: none;
}

body.dark .product-info-icon {
  stroke: #3399ff;
}

/* Style for the label */
.product-info-label {
  font-weight: 600;
  margin-right: 8px;
}

.transaction-form {
  padding: 15px;
  background: #f9f9f9;
  border-radius: 8px;
}

body.dark .transaction-form {
  background: #2a2a2a;
}

.transaction-form h3 {
  margin-top: 0;
  margin-bottom: 15px;
  font-size: 1.1rem;
  color: #007bff;
}

body.dark .transaction-form h3 {
  color: #3399ff;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-size: 0.9rem;
  font-weight: 600;
}

.form-control {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 1rem;
  background: #fff;
  color: #333;
}

body.dark .form-control {
  background: #444;
  border-color: #555;
  color: #eee;
}

.total-section {
  background: #e9f7ef;
  padding: 10px;
  border-radius: 6px;
  margin-top: 15px;
}

body.dark .total-section {
  background: #2c3e50;
}

.total-price {
  font-size: 1.2rem;
  font-weight: 600;
  color: #27ae60;
}

body.dark .total-price {
  color: #2ecc71;
}

/* Updated form actions to accommodate 3 buttons */
.form-actions {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
  gap: 8px;
}

.btn-primary, .btn-secondary {
  padding: 10px;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  font-size: 0.85rem;
}

.button-icon {
  width: 16px;
  height: 16px;
  stroke: currentColor;
  stroke-width: 2;
  fill: none;
}

.btn-primary {
  background: #007bff;
  color: white;
  flex: 1.5;
}

.btn-primary:hover {
  background: #0069d9;
  box-shadow: 0 0 10px rgba(0, 105, 217, 0.5);
  transform: translateY(-2px);
}

.btn-secondary {
  background: #6c757d;
  color: white;
  flex: 1;
}

.btn-secondary:hover {
  background: #5a6268;
  box-shadow: 0 0 10px rgba(90, 98, 104, 0.5);
  transform: translateY(-2px);
}

#scan-more {
  background: #28a745;
}

#scan-more:hover {
  background: #218838;
  box-shadow: 0 0 10px rgba(33, 136, 56, 0.5);
}

/* Toast notification styles */
.scan-toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 10px 20px;
  border-radius: 20px;
  font-size: 14px;
  z-index: 2000;
  opacity: 0;
  transition: opacity 0.3s ease;
  max-width: 280px;
  text-align: center;
  box-shadow: 0px 3px 10px rgba(0, 0, 0, 0.2);
}

.scan-toast.visible {
  opacity: 1;
}

/* Scanner active indicator styles */
.viewport.scanner-active {
  position: relative;
}

.viewport.scanner-active::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  width: 100%;
  height: 2px;
  background-color: rgba(255, 0, 0, 0.7);
  animation: scanline 2s linear infinite;
}

@keyframes scanline {
  0% {
    top: 0%;
  }
  50% {
    top: 100%;
  }
  100% {
    top: 0%;
  }
}
`;

document.head.appendChild(styleElement);


    function handleShutdown() {
      alert('Close application');
    }


// Pastikan activeStoreId diambil sekali dan global

async function fetchTodayRevenue() {
  if (!activeStoreId) return 0;

  try {
    // Create today's date at midnight
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Create tomorrow's date at midnight
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    // Convert to Firestore timestamps if using Firebase v9 compat
    const todayTimestamp = firebase.firestore.Timestamp.fromDate(today);
    const tomorrowTimestamp = firebase.firestore.Timestamp.fromDate(tomorrow);

    console.log('Fetching revenue for:', today, 'to', tomorrow);
    console.log('Active Store ID:', activeStoreId);

    // Query history collection for today's transactions
    const snapshot = await window.firebaseUtils.historyCollection
      .where('kategori', '==', 'keluar')
      .where('storeId', '==', activeStoreId)
      .get();

    // Process all documents and filter by date manually
    let totalRevenue = 0;
    snapshot.docs.forEach(doc => {
      const data = doc.data();
      
      // Get the timestamp and convert to Date for comparison
      let transactionDate;
      if (data.tanggal && typeof data.tanggal.toDate === 'function') {
        transactionDate = data.tanggal.toDate();
      } else if (data.tanggal instanceof Date) {
        transactionDate = data.tanggal;
      } else if (data.tanggal) {
        // Try to parse as date if it's a string
        transactionDate = new Date(data.tanggal);
      }
      
      // Check if the transaction date is today
      if (transactionDate && 
          transactionDate >= today && 
          transactionDate < tomorrow) {
        
        const qty = data.jumlah || 0;
        const price = data.harga || 0;
        
        console.log(`Transaction: ${data.namaBarang}, Qty: ${qty}, Price: ${price}, Total: ${qty * price}`);
        totalRevenue += qty * price;
      }
    });

    console.log('Total Revenue:', totalRevenue);
    return totalRevenue;
  } catch (error) {
    console.error('Error fetching today revenue:', error);
    return 0;
  }
}

async function updateTodayRevenueDisplay() {
  const revenueAmountElem = document.querySelector('.revenue-amount');
  if (!revenueAmountElem) return;

  try {
    const totalRevenue = await fetchTodayRevenue();
    revenueAmountElem.textContent = 'Rp ' + totalRevenue.toLocaleString('id-ID');
  } catch (error) {
    console.error('Gagal mengambil pendapatan hari ini:', error);
    revenueAmountElem.textContent = 'Rp 0';
  }
}

// Saat halaman siap dan firebase utils siap, panggil initCharts dan updateTodayRevenueDisplay
window.addEventListener('DOMContentLoaded', () => {
  if (activeStoreId && window.firebaseUtils && window.firebaseUtils.historyCollection && window.firebaseUtils.productsCollection) {
    initCharts();
    updateTodayRevenueDisplay();
  } else {
    console.warn('Store belum dipilih atau Firebase belum siap');
  }
});

    
    // Run initialization when DOM is ready and Firebase is ready
    window.addEventListener('DOMContentLoaded', () => {
      // Ambil foto profil dari localStorage
      const profilePhoto = localStorage.getItem('profilePhoto');
      const profilePhotoElem = document.querySelector('.profile-photo');

      if (profilePhoto && profilePhotoElem) {
        profilePhotoElem.style.backgroundImage = `url('${profilePhoto}')`;
      } else {
        // fallback ke default avatar
        if (profilePhotoElem) {
          profilePhotoElem.style.backgroundImage = "url('https://i.pravatar.cc/48')";
        }
      }
    });

    // Panggil fungsi ini setelah memilih atau menambah toko
function onStoreSelected(store) {
  saveActiveStoreToLocalStorage(store);
  window.location.href = 'index.html'; // Arahkan kembali ke index.html
}


window.addEventListener('DOMContentLoaded', () => {
  // Ambil data toko aktif dari localStorage
  const activeStoreId = localStorage.getItem('activeStoreId');
  const storeName = localStorage.getItem('storeName') || 'Nama Toko';
  const storeAddress = localStorage.getItem('storeAddress') || 'Alamat Toko';
  const addressLink = localStorage.getItem('addressLink') || '#';

  const companyNameElem = document.querySelector('.company-name h1');
  const companyAddressElem = document.querySelector('.company-address p');
  const companyLinkElem = document.querySelector('.company-name');

  const profilePhoto = localStorage.getItem('profilePhoto');
  const profilePhotoElem = document.querySelector('.profile-photo');
  
  if (profilePhoto && profilePhotoElem) {
    profilePhotoElem.style.backgroundImage = `url('${profilePhoto}')`;
  } else {
    // fallback to default avatar
    if (profilePhotoElem) {
      profilePhotoElem.style.backgroundImage = "url('https://i.pravatar.cc/48')";
    }
  }

  if (activeStoreId) {
    if (companyNameElem) companyNameElem.textContent = storeName;
    if (companyAddressElem) companyAddressElem.textContent = storeAddress;
    if (companyLinkElem) companyLinkElem.href = addressLink;

    if (profilePhotoElem && profilePhoto) {
      profilePhotoElem.style.backgroundImage = `url('${profilePhoto}')`;
    }
  } else {
    // Jika tidak ada data toko aktif, gunakan data default (seperti sekarang)
    if (profilePhotoElem && profilePhoto) {
      profilePhotoElem.style.backgroundImage = `url('${profilePhoto}')`;
    }
  }
});


// Setelah transaksi berhasil diproses di processAllTransactions()
async function processAllTransactions() {
  if (!window.scannedProducts || window.scannedProducts.length === 0) {
    alert('Tidak ada produk yang diproses.');
    return;
  }

  try {
    const batch = firebase.firestore().batch();

    for (const p of window.scannedProducts) {
      const productRef = window.firebaseUtils.productsCollection.doc(p.id);

      let newStock;
      if (window.currentTransactionType === 'keluar') {
        if (p.quantity > p.stok) {
          alert(`Stok tidak cukup untuk produk ${p.namaBarang}. Stok tersedia: ${p.stok}`);
          return;
        }
        newStock = p.stok - p.quantity;
      } else {
        newStock = p.stok + p.quantity;
      }

      batch.update(productRef, { stok: newStock });

      const historyRef = window.firebaseUtils.historyCollection.doc();
      const historyData = {
        barcode: p.barcode || '',
        tanggal: firebase.firestore.Timestamp.now(),
        namaBarang: p.namaBarang,
        brand: p.brand || '',
        kategori: window.currentTransactionType,
        jumlah: p.quantity,
        harga: p.harga,  // Tambahkan harga produk di sini
        keterangan: `Transaksi via Scan Barcode`,
        storeId: activeStoreId,
        oleh: 'Aplikasi Scan'
      };
      batch.set(historyRef, historyData);


    }

    await batch.commit();

    window.scannedProductsCopy = JSON.parse(JSON.stringify(window.scannedProducts)); // Simpan data transaksi untuk resi
    window.currentTransactionTypeCopy = window.currentTransactionType;

    // Tampilkan popup hasil transaksi dengan 3 tombol
    showTransactionResultPopup();

  } catch (error) {
    console.error('Error processing transactions:', error);
    alert('Terjadi kesalahan saat memproses transaksi. Silakan coba lagi.');
  }
}

// Fungsi menampilkan popup hasil transaksi dengan 3 tombol
function showTransactionResultPopup() {
  const overlay = document.getElementById('overlay');
  overlay.innerHTML = `
    <div id="resultModal" class="modal product-modal" role="dialog" aria-modal="true" style="max-height: 90vh; overflow-y: auto;">
      <h2 style="text-align: center;">Transaksi Berhasil</h2>
      <p style="text-align:center;">Transaksi telah berhasil diproses.</p>
      <div style="display: flex; justify-content: center; gap: 12px; margin-top: 20px;">
        <button id="btnViewReceipt" class="btn-primary" style="flex:1;">Lihat Resi</button>
        <button id="btnPrintReceipt" class="btn-secondary" style="flex:1;">Print/Save Resi</button>
        <button id="btnOk" class="btn-secondary" style="flex:1;">Oke</button>
      </div>
    </div>
  `;
  overlay.classList.add('active');
  overlay.setAttribute('aria-hidden', 'false');

  // Center modal
  const modal = document.getElementById('resultModal');
  const centerLeft = (window.innerWidth - modal.offsetWidth) / 2;
  const centerTop = (window.innerHeight - modal.offsetHeight) / 2;
  modal.style.left = `${centerLeft}px`;
  modal.style.top = `${centerTop}px`;
  modal.classList.add('active');

  // Event tombol
  document.getElementById('btnViewReceipt').onclick = () => {
    showReceipt(window.scannedProductsCopy, window.currentTransactionTypeCopy);
  };
  document.getElementById('btnPrintReceipt').onclick = () => {
    printReceipt();
  };
  document.getElementById('btnOk').onclick = () => {
    closeResultModal();
    window.scannedProducts = [];
    updateTodayRevenueDisplay();
  };
}

// Fungsi menutup modal hasil transaksi
function closeResultModal() {
  const overlay = document.getElementById('overlay');
  const modal = document.getElementById('resultModal');
  if (modal) modal.classList.remove('active');
  setTimeout(() => {
    overlay.classList.remove('active');
    overlay.setAttribute('aria-hidden', 'true');
    overlay.innerHTML = '';
  }, 300);
}

// Fungsi menampilkan resi transaksi dengan desain sesuai permintaan
function showReceipt(products, transactionType) {
  if (!products || products.length === 0) {
    alert('Tidak ada data transaksi untuk ditampilkan.');
    return;
  }

  const overlay = document.getElementById('overlay');

  // Ambil data toko dan profil
  const profilePhotoElem = document.querySelector('.profile-photo');
  const logoUrl = profilePhotoElem ? getComputedStyle(profilePhotoElem).backgroundImage.slice(5, -2) : '';
  const storeName = localStorage.getItem('storeName') || 'Nama Toko';
  const storeAddress = localStorage.getItem('storeAddress') || 'Alamat Toko';

  // Hitung total harga
  let totalAmount = 0;
  products.forEach(p => {
    totalAmount += p.harga * p.quantity;
  });

  // Format tanggal sekarang
  const now = new Date();
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  const formattedDate = now.toLocaleDateString('id-ID', options);

  // Bangun baris tabel item
  let rowsHTML = '';
  products.forEach(p => {
    rowsHTML += `
      <tr>
        <td>${p.quantity}</td>
        <td>${p.namaBarang}</td>
        <td>Rp ${p.harga.toLocaleString('id-ID')}</td>
        <td>Rp ${(p.harga * p.quantity).toLocaleString('id-ID')}</td>
      </tr>
    `;
  });

  // HTML resi
  const receiptHTML = `
    <div class="bill-container" style="max-width: 90vw; max-height: 90vh; overflow-y: auto; background: white; border-radius: 8px; padding: 20px 30px 40px; box-shadow: 0 6px 12px rgb(0 0 0 / 0.1); color: #333; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
      <header style="text-align: center; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">
        <img src="${logoUrl}" alt="Logo Toko" style="height: 60px; margin-bottom: 8px; border-radius: 50%;" />
        <h1 style="margin: 0; font-size: 1.8rem; color: #007bff;">${storeName}</h1>
        <p style="margin: 2px 0; font-size: 0.9rem; color: #555;">${storeAddress}</p>
        <p class="date" style="margin-top: 6px; font-size: 0.85rem; color: #888;">${formattedDate}</p>
      </header>

      <table style="width: 100%; border-collapse: collapse; margin-bottom: 18px;">
        <thead style="background-color: #007bff; color: white;">
          <tr>
            <th style="padding: 8px 12px; border: 1px solid #ddd; text-align: left;">Banyaknya</th>
            <th style="padding: 8px 12px; border: 1px solid #ddd; text-align: left;">Nama Barang</th>
            <th style="padding: 8px 12px; border: 1px solid #ddd; text-align: left;">Harga (Rp)</th>
            <th style="padding: 8px 12px; border: 1px solid #ddd; text-align: left;">Jumlah Harga (Rp)</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHTML}
        </tbody>
        <tfoot>
          <tr style="font-weight: bold; color: #007bff;">
            <td colspan="3" style="padding: 8px 12px; border: 1px solid #ddd; text-align: left;">Total Jumlah</td>
            <td style="padding: 8px 12px; border: 1px solid #ddd; text-align: left;">Rp ${totalAmount.toLocaleString('id-ID')}</td>
          </tr>
        </tfoot>
      </table>

      <div class="signature-section" style="margin-top: 40px; font-size: 0.9rem; text-align: center; width: 200px; margin-left: auto; margin-right: auto;">
        <div><strong>Cap Tanda Terima:</strong></div>
        <div class="signature" style="border-top: 2px solid #333; margin-top: 50px; padding-top: 6px; font-weight: 600; color: #333;"></div>
      </div>

      <div class="note" style="margin-top: 30px; font-size: 0.85rem; color: white; background-color: #b22222; padding: 10px; border-radius: 5px; text-align: center;">
        Barang yang sudah dibeli tidak dapat dikembalikan/tukar
      </div>

      <div style="margin-top: 20px; text-align: center;">
        <button id="btnBackFromReceipt" class="btn-secondary" style="padding: 10px 20px; font-weight: 600; border-radius: 6px;">Kembali</button>
      </div>
    </div>
  `;

  overlay.innerHTML = receiptHTML;

  // Center modal
  const modal = overlay.querySelector('.bill-container');
  const centerLeft = (window.innerWidth - modal.offsetWidth) / 2;
  const centerTop = (window.innerHeight - modal.offsetHeight) / 2;
  modal.style.position = 'fixed';
  modal.style.left = `${centerLeft}px`;
  modal.style.top = `${centerTop}px`;
  modal.style.zIndex = 1100;

  // Event tombol kembali
  document.getElementById('btnBackFromReceipt').onclick = () => {
    // Tampilkan popup hasil transaksi lagi
    showTransactionResultPopup();
  };
}

// Fungsi print/save resi
// Fungsi print/save resi
function printReceipt() {
  // Buat window baru untuk print
  const printWindow = window.open('', '_blank', 'width=600,height=800');
  if (!printWindow) {
    alert('Pop-up blocker terdeteksi. Izinkan pop-up untuk mencetak resi.');
    return;
  }

  // Ambil data dari scannedProductsCopy
  const products = window.scannedProductsCopy;
  if (!products || products.length === 0) {
    alert('Tidak ada data transaksi untuk dicetak.');
    return;
  }

  // Ambil data toko dan profil
  const profilePhotoElem = document.querySelector('.profile-photo');
  const logoUrl = profilePhotoElem ? getComputedStyle(profilePhotoElem).backgroundImage.slice(5, -2) : '';
  const storeName = localStorage.getItem('storeName') || 'Nama Toko';
  const storeAddress = localStorage.getItem('storeAddress') || 'Alamat Toko';

  // Hitung total harga
  let totalAmount = 0;
  products.forEach(p => {
    totalAmount += p.harga * p.quantity;
  });

  // Format tanggal sekarang
  const now = new Date();
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  const formattedDate = now.toLocaleDateString('id-ID', options);

  // Bangun baris tabel item
  let rowsHTML = '';
  products.forEach(p => {
    rowsHTML += `
      <tr>
        <td>${p.quantity}</td>
        <td>${p.namaBarang}</td>
        <td>Rp ${p.harga.toLocaleString('id-ID')}</td>
        <td>Rp ${(p.harga * p.quantity).toLocaleString('id-ID')}</td>
      </tr>
    `;
  });

  const printHTML = `
  <html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Struk Pembelian</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f8f9fa;
        margin: 0;
        padding: 20px;
        color: #333;
      }
      .bill-container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 6px 12px rgb(0 0 0 / 0.1);
        padding: 20px 30px 40px;
      }
      header {
        text-align: center;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
      header img {
        height: 60px;
        margin-bottom: 8px;
        border-radius: 50%;
      }
      header h1 {
        margin: 0;
        font-size: 1.8rem;
        color: #007bff;
      }
      header p {
        margin: 2px 0;
        font-size: 0.9rem;
        color: #555;
      }
      header .date {
        margin-top: 6px;
        font-size: 0.85rem;
        color: #888;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 18px;
      }
      thead {
        background-color: #007bff;
        color: white;
      }
      th, td {
        padding: 8px 12px;
        border: 1px solid #ddd;
        text-align: left;
        font-size: 0.95rem;
      }
      tbody tr:nth-child(even) {
        background-color: #f9fafb;
      }
      .total-row {
        font-weight: bold;
        color: #007bff;
      }
      .signature-section {
        margin-top: 40px;
        font-size: 0.9rem;
        text-align: center;
        width: 200px;
        margin-left: auto;
        margin-right: auto;
      }
      .signature {
        border-top: 2px solid #333;
        margin-top: 50px;
        padding-top: 6px;
        font-weight: 600;
        color: #333;
      }
      .note {
        margin-top: 30px;
        font-size: 0.85rem;
        color: white;
        background-color: #b22222;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="bill-container">
      <header>
        <img src="${logoUrl}" alt="Logo Toko" />
        <h1>${storeName}</h1>
        <p>${storeAddress}</p>
        <p class="date">${formattedDate}</p>
      </header>

      <table>
        <thead>
          <tr>
            <th>Banyaknya</th>
            <th>Nama Barang</th>
            <th>Harga (Rp)</th>
            <th>Jumlah Harga (Rp)</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHTML}
        </tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="3">Total Jumlah</td>
            <td>Rp ${totalAmount.toLocaleString('id-ID')}</td>
          </tr>
        </tfoot>
      </table>

      <div class="signature-section">
        <div><strong>Cap Tanda Terima:</strong></div>
        <div class="signature"></div>
      </div>

      <div class="note">Barang yang sudah dibeli tidak dapat dikembalikan/tukar</div>
    </div>
  </body>
  </html>
  `;

  printWindow.document.write(printHTML);
  printWindow.document.close();
  printWindow.focus();

  // Tunggu sebentar lalu jalankan print
  setTimeout(() => {
    printWindow.print();
    // printWindow.close(); // opsional, tutup window setelah print
  }, 500);
}


async function handleShutdown() {
  try {
    // 1. Ambil data barang terjual hari ini dan pendapatan hari ini dari Firestore
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);

    // Ambil transaksi keluar hari ini
    const snapshot = await window.firebaseUtils.historyCollection
      .where('kategori', '==', 'keluar')
      .where('storeId', '==', activeStoreId)
      .get();

    // Kumpulkan data barang dan total pendapatan
    const barangTerjual = {};
    let totalPendapatan = 0;

    snapshot.docs.forEach(doc => {
      const data = doc.data();
      let tglTransaksi = null;
      if (data.tanggal && typeof data.tanggal.toDate === 'function') {
        tglTransaksi = data.tanggal.toDate();
      }
      if (tglTransaksi && tglTransaksi >= today && tglTransaksi < tomorrow) {
        const nama = data.namaBarang || 'Unknown';
        const qty = data.jumlah || 0;
        const harga = data.harga || 0;

        if (!barangTerjual[nama]) barangTerjual[nama] = 0;
        barangTerjual[nama] += qty;
        totalPendapatan += qty * harga;
      }
    });

    // Format pesan untuk WhatsApp
    let pesan = `*Laporan Penjualan Hari Ini*\n\n`;
    pesan += `Pendapatan Total: Rp ${totalPendapatan.toLocaleString('id-ID')}\n\n`;
    pesan += `Barang Terjual:\n`;
    for (const [nama, qty] of Object.entries(barangTerjual)) {
      pesan += `- ${nama}: ${qty} pcs\n`;
    }

    // Encode pesan agar bisa dipakai di URL
    const encodedPesan = encodeURIComponent(pesan);

    // Nomor grup WhatsApp (gunakan format internasional tanpa tanda +, misal 6281234567890)
    // Ganti dengan nomor grup admin atau nomor tujuan yang sesuai
    const nomorGrup = '6281234567890'; // <-- Ganti dengan nomor grup WA Anda

    // Buka WhatsApp dengan pesan terisi
    const waUrl = `https://api.whatsapp.com/send?phone=${nomorGrup}&text=${encodedPesan}`;
    window.open(waUrl, '_blank');

    // 2. Close aplikasi / tutup tab (jika memungkinkan)
    // Coba tutup tab, jika tidak berhasil, arahkan ke halaman kosong
    setTimeout(() => {
      if (window.confirm('Aplikasi akan ditutup. Klik OK untuk menutup tab ini.')) {
        window.close();
      } else {
        // Jika tidak bisa tutup, arahkan ke halaman kosong
        window.location.href = 'about:blank';
      }
    }, 1000);

  } catch (error) {
    console.error('Error saat proses shutdown:', error);
    alert('Gagal mengirim laporan penjualan. Silakan coba lagi.');
  }
}


  </script>
</body>
</html>